define(["require", "exports", "../../../common/packageConversion/enum/objectTypeEnum", "../../../common/persistence/settings", "../../../common/packageConversion/enum/dataTypeEnum", "../../../common/packageConversion/enum/additionalMetaKeys", "../../../common/packageConversion/mceConversionError", "./settingIds", "../../../common/packageConversion/enum/arrayTypeEnum", "../../../common/packageConversion/meta", "../../../common/packageConversion/package"], function (require, exports, objectTypeEnum_1, settings_1, dataTypeEnum_1, additionalMetaKeys_1, mceConversionError_1, settingIds_1, arrayTypeEnum_1, meta_1, package_1) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    var DataIds;
    (function (DataIds) {
        DataIds["Name"] = "name";
        DataIds["XValues"] = "xValues";
        DataIds["YValues"] = "yValues";
    })(DataIds || (DataIds = {}));
    var SignalPackageAdapter = /** @class */ (function () {
        function SignalPackageAdapter() {
            //newest version of the package format
            this.currentPackageVersion = 1;
            this.settingsType = "Signal";
            this.objectType = objectTypeEnum_1.ObjectType.SIGNAL;
        }
        SignalPackageAdapter.prototype.packageToSetting = function (packageData, container) {
            var _a, _b, _c;
            var setting = new settings_1.Settings(this.settingsType);
            if (((_a = packageData === null || packageData === void 0 ? void 0 : packageData.meta) === null || _a === void 0 ? void 0 : _a.dataType) == dataTypeEnum_1.DataType.OBJECT && ((_b = packageData === null || packageData === void 0 ? void 0 : packageData.meta) === null || _b === void 0 ? void 0 : _b[additionalMetaKeys_1.AdditionalMetaKeys.OBJECTTYPE]) == this.objectType) {
                switch ((_c = packageData === null || packageData === void 0 ? void 0 : packageData.meta) === null || _c === void 0 ? void 0 : _c[additionalMetaKeys_1.AdditionalMetaKeys.VERSION]) {
                    case 1:
                        setting = this.packageV1ToSetting(packageData, container);
                        break;
                    default:
                        throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.UNSUPPORTED_VERSION, this.objectType);
                }
            }
            else {
                throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.UNSUPPORTED_TYPE, this.objectType);
            }
            return setting;
        };
        SignalPackageAdapter.prototype.packageV1ToSetting = function (packageData, container) {
            var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k, _l, _m, _o, _p, _q, _r, _s, _t, _u, _v, _w;
            var setting = new settings_1.Settings(this.settingsType);
            var xValues = new Array();
            var yValues = new Array();
            var points = new Array();
            if (((_c = (_b = (_a = packageData === null || packageData === void 0 ? void 0 : packageData.data) === null || _a === void 0 ? void 0 : _a[DataIds.Name]) === null || _b === void 0 ? void 0 : _b.meta) === null || _c === void 0 ? void 0 : _c.dataType) == dataTypeEnum_1.DataType.STRING) {
                setting.setValue(settingIds_1.SettingIds.Name, (_e = (_d = packageData === null || packageData === void 0 ? void 0 : packageData.data) === null || _d === void 0 ? void 0 : _d[DataIds.Name]) === null || _e === void 0 ? void 0 : _e.data);
            }
            else {
                throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.MISSING_DATA, DataIds.Name);
            }
            if (((_h = (_g = (_f = packageData === null || packageData === void 0 ? void 0 : packageData.data) === null || _f === void 0 ? void 0 : _f[DataIds.XValues]) === null || _g === void 0 ? void 0 : _g.meta) === null || _h === void 0 ? void 0 : _h.dataType) == dataTypeEnum_1.DataType.ARRAY && ((_l = (_k = (_j = packageData === null || packageData === void 0 ? void 0 : packageData.data) === null || _j === void 0 ? void 0 : _j[DataIds.XValues]) === null || _k === void 0 ? void 0 : _k.meta) === null || _l === void 0 ? void 0 : _l[additionalMetaKeys_1.AdditionalMetaKeys.ARRAYTYPE]) == arrayTypeEnum_1.ArrayType.NUMBER) {
                xValues = (_o = (_m = packageData === null || packageData === void 0 ? void 0 : packageData.data) === null || _m === void 0 ? void 0 : _m[DataIds.XValues]) === null || _o === void 0 ? void 0 : _o.data;
            }
            else {
                throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.MISSING_DATA, DataIds.XValues);
            }
            if (((_r = (_q = (_p = packageData === null || packageData === void 0 ? void 0 : packageData.data) === null || _p === void 0 ? void 0 : _p[DataIds.YValues]) === null || _q === void 0 ? void 0 : _q.meta) === null || _r === void 0 ? void 0 : _r.dataType) == dataTypeEnum_1.DataType.ARRAY && ((_u = (_t = (_s = packageData === null || packageData === void 0 ? void 0 : packageData.data) === null || _s === void 0 ? void 0 : _s[DataIds.YValues]) === null || _t === void 0 ? void 0 : _t.meta) === null || _u === void 0 ? void 0 : _u[additionalMetaKeys_1.AdditionalMetaKeys.ARRAYTYPE]) == arrayTypeEnum_1.ArrayType.NUMBER) {
                yValues = (_w = (_v = packageData === null || packageData === void 0 ? void 0 : packageData.data) === null || _v === void 0 ? void 0 : _v[DataIds.YValues]) === null || _w === void 0 ? void 0 : _w.data;
            }
            else {
                throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.MISSING_DATA, DataIds.YValues);
            }
            if (xValues.length !== yValues.length) {
                throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.MISSING_DATA, "Length of " + DataIds.XValues + " does not match length of " + DataIds.YValues);
            }
            setting.setValue(settingIds_1.SettingIds.RawPointsX, xValues);
            setting.setValue(settingIds_1.SettingIds.RawPointsY, yValues);
            return setting;
        };
        SignalPackageAdapter.prototype.settingToPackage = function (settingsData) {
            var settings = settings_1.Settings.create(settingsData);
            var signalData = {};
            var packageStructure = {
                packages: new Array(),
                topLevelID: NaN
            };
            if (settings.type === this.settingsType) {
                var id = meta_1.Meta.createID();
                var additionalMetaInfo = [{ key: additionalMetaKeys_1.AdditionalMetaKeys.OBJECTTYPE, value: this.objectType }, { key: additionalMetaKeys_1.AdditionalMetaKeys.ID, value: id }, { key: additionalMetaKeys_1.AdditionalMetaKeys.VERSION, value: this.currentPackageVersion }];
                var signalMeta = new meta_1.Meta(dataTypeEnum_1.DataType.OBJECT, additionalMetaInfo);
                var nameData = settings.getValue(settingIds_1.SettingIds.Name);
                if (nameData !== undefined) {
                    signalData[DataIds.Name] = new package_1.Package(new meta_1.Meta(dataTypeEnum_1.DataType.STRING), nameData);
                }
                else {
                    throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.MISSING_DATA, settingIds_1.SettingIds.Name);
                }
                // suport for old points definition (new definition is RawPointsX and RawPointsY)
                var pointData = settings.getValue("points");
                if (pointData !== undefined) {
                    signalData[DataIds.XValues] = new package_1.Package(new meta_1.Meta(dataTypeEnum_1.DataType.ARRAY, [{ key: additionalMetaKeys_1.AdditionalMetaKeys.ARRAYTYPE, value: arrayTypeEnum_1.ArrayType.NUMBER }]), pointData.map(function (s) { return Number(s.split(";")[0]); }));
                    signalData[DataIds.YValues] = new package_1.Package(new meta_1.Meta(dataTypeEnum_1.DataType.ARRAY, [{ key: additionalMetaKeys_1.AdditionalMetaKeys.ARRAYTYPE, value: arrayTypeEnum_1.ArrayType.NUMBER }]), pointData.map(function (s) { return Number(s.split(";")[1]); }));
                }
                else {
                    var rawPointsX = settings.getValue(settingIds_1.SettingIds.RawPointsX);
                    if (rawPointsX !== undefined) {
                        signalData[DataIds.XValues] = new package_1.Package(new meta_1.Meta(dataTypeEnum_1.DataType.ARRAY, [{ key: additionalMetaKeys_1.AdditionalMetaKeys.ARRAYTYPE, value: arrayTypeEnum_1.ArrayType.NUMBER }]), rawPointsX.map(function (s) { return s; }));
                    }
                    else {
                        throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.MISSING_DATA, settingIds_1.SettingIds.RawPointsX);
                    }
                    var rawPointsY = settings.getValue(settingIds_1.SettingIds.RawPointsY);
                    if (rawPointsY !== undefined) {
                        signalData[DataIds.YValues] = new package_1.Package(new meta_1.Meta(dataTypeEnum_1.DataType.ARRAY, [{ key: additionalMetaKeys_1.AdditionalMetaKeys.ARRAYTYPE, value: arrayTypeEnum_1.ArrayType.NUMBER }]), rawPointsY.map(function (s) { return s; }));
                    }
                    else {
                        throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.MISSING_DATA, settingIds_1.SettingIds.RawPointsY);
                    }
                }
                var signalPackage = new package_1.Package(signalMeta, signalData);
                packageStructure.packages.push(signalPackage);
                packageStructure.topLevelID = id;
            }
            else {
                throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.UNSUPPORTED_VERSION, this.settingsType);
            }
            return packageStructure;
        };
        return SignalPackageAdapter;
    }());
    exports.SignalPackageAdapter = SignalPackageAdapter;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2lnbmFsUGFja2FnZUFkYXB0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvYXBwL21vZGVscy9jb21tb24vc2lnbmFsL3NpZ25hbFBhY2thZ2VBZGFwdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztJQWVBLElBQUssT0FJSjtJQUpELFdBQUssT0FBTztRQUNSLHdCQUFhLENBQUE7UUFDYiw4QkFBbUIsQ0FBQTtRQUNuQiw4QkFBbUIsQ0FBQTtJQUN2QixDQUFDLEVBSkksT0FBTyxLQUFQLE9BQU8sUUFJWDtJQUVEO1FBU0k7WUFOQSxzQ0FBc0M7WUFDckIsMEJBQXFCLEdBQVcsQ0FBQyxDQUFDO1lBTS9DLElBQUksQ0FBQyxZQUFZLEdBQUcsUUFBUSxDQUFDO1lBQzdCLElBQUksQ0FBQyxVQUFVLEdBQUcsMkJBQVUsQ0FBQyxNQUFNLENBQUM7UUFDeEMsQ0FBQztRQUVELCtDQUFnQixHQUFoQixVQUFpQixXQUFxQixFQUFFLFNBQTBCOztZQUU5RCxJQUFJLE9BQU8sR0FBYyxJQUFJLG1CQUFRLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBRXpELElBQUcsT0FBQSxXQUFXLGFBQVgsV0FBVyx1QkFBWCxXQUFXLENBQUUsSUFBSSwwQ0FBRSxRQUFRLEtBQUksdUJBQVEsQ0FBQyxNQUFNLElBQUksT0FBQSxXQUFXLGFBQVgsV0FBVyx1QkFBWCxXQUFXLENBQUUsSUFBSSwwQ0FBRyx1Q0FBa0IsQ0FBQyxVQUFVLE1BQUssSUFBSSxDQUFDLFVBQVUsRUFBRTtnQkFFeEgsY0FBTyxXQUFXLGFBQVgsV0FBVyx1QkFBWCxXQUFXLENBQUUsSUFBSSwwQ0FBRyx1Q0FBa0IsQ0FBQyxPQUFPLEdBQUU7b0JBQ25ELEtBQUssQ0FBQzt3QkFDRixPQUFPLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFdBQVcsRUFBRSxTQUFTLENBQUMsQ0FBQzt3QkFDMUQsTUFBTTtvQkFDVjt3QkFDSSxNQUFN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dUNBQWtCLENBQUMsaUJBQWlCLENBQUMsMkNBQXNCLENBQUMsWUFBWSxFQUFFLHVCQUFVLENBQUMsVUFBVSxDQUFDLENBQUM7cUJBQzFHO2lCQUNKO2dCQUVELElBQUksYUFBYSxHQUFHLElBQUksaUJBQU8sQ0FBQyxVQUFVLEVBQUUsVUFBVSxDQUFDLENBQUM7Z0JBRXhELGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7Z0JBQzlDLGdCQUFnQixDQUFDLFVBQVUsR0FBRyxFQUFFLENBQUM7YUFDcEM7aUJBQU07Z0JBQ0gsTUFBTSx1Q0FBa0IsQ0FBQyxpQkFBaUIsQ0FBQywyQ0FBc0IsQ0FBQyxtQkFBbUIsRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7YUFFN0c7WUFFRCxPQUFPLGdCQUFnQixDQUFDO1FBQzVCLENBQUM7UUFDTCwyQkFBQztJQUFELENBQUMsQUEvSEQsSUErSEM7SUFFUSxvREFBb0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJUGFja2FnZUFkYXB0ZXIsIFBhY2thZ2VBcnJheVdpdGhUb3BMZXZlbElEIH0gZnJvbSBcIi4uLy4uLy4uL2NvbW1vbi9wYWNrYWdlQ29udmVyc2lvbi9pbnRlcmZhY2UvcGFja2FnZUFkYXB0ZXJJbnRlcmZhY2VcIjtcclxuaW1wb3J0IHsgT2JqZWN0VHlwZSB9IGZyb20gXCIuLi8uLi8uLi9jb21tb24vcGFja2FnZUNvbnZlcnNpb24vZW51bS9vYmplY3RUeXBlRW51bVwiO1xyXG5pbXBvcnQgeyBJUGFja2FnZSB9IGZyb20gXCIuLi8uLi8uLi9jb21tb24vcGFja2FnZUNvbnZlcnNpb24vaW50ZXJmYWNlL3BhY2thZ2VJbnRlcmZhY2VcIjtcclxuaW1wb3J0IHsgRXhwb3J0Q29udGFpbmVyIH0gZnJvbSBcIi4uLy4uLy4uL2NvbW1vbi9wYWNrYWdlQ29udmVyc2lvbi9leHBvcnRDb250YWluZXJcIjtcclxuaW1wb3J0IHsgSVNldHRpbmdzIH0gZnJvbSBcIi4uLy4uLy4uL2NvbW1vbi9wZXJzaXN0ZW5jZS9pbnRlcmZhY2VzL3NldHRpbmdzSW50ZXJmYWNlXCI7XHJcbmltcG9ydCB7IFNldHRpbmdzIH0gZnJvbSBcIi4uLy4uLy4uL2NvbW1vbi9wZXJzaXN0ZW5jZS9zZXR0aW5nc1wiO1xyXG5pbXBvcnQgeyBEYXRhVHlwZSB9IGZyb20gXCIuLi8uLi8uLi9jb21tb24vcGFja2FnZUNvbnZlcnNpb24vZW51bS9kYXRhVHlwZUVudW1cIjtcclxuaW1wb3J0IHsgQWRkaXRpb25hbE1ldGFLZXlzIH0gZnJvbSBcIi4uLy4uLy4uL2NvbW1vbi9wYWNrYWdlQ29udmVyc2lvbi9lbnVtL2FkZGl0aW9uYWxNZXRhS2V5c1wiO1xyXG5pbXBvcnQgeyBNY2VDb252ZXJzaW9uRXJyb3IsIE1jZUNvbnZlcnNpb25FcnJvclR5cGUgfSBmcm9tIFwiLi4vLi4vLi4vY29tbW9uL3BhY2thZ2VDb252ZXJzaW9uL21jZUNvbnZlcnNpb25FcnJvclwiO1xyXG5pbXBvcnQgeyBTZXR0aW5nSWRzIH0gZnJvbSBcIi4vc2V0dGluZ0lkc1wiO1xyXG5pbXBvcnQgeyBBcnJheVR5cGUgfSBmcm9tIFwiLi4vLi4vLi4vY29tbW9uL3BhY2thZ2VDb252ZXJzaW9uL2VudW0vYXJyYXlUeXBlRW51bVwiO1xyXG5pbXBvcnQgeyBNZXRhIH0gZnJvbSBcIi4uLy4uLy4uL2NvbW1vbi9wYWNrYWdlQ29udmVyc2lvbi9tZXRhXCI7XHJcbmltcG9ydCB7IFBhY2thZ2UgfSBmcm9tIFwiLi4vLi4vLi4vY29tbW9uL3BhY2thZ2VDb252ZXJzaW9uL3BhY2thZ2VcIjtcclxuXHJcblxyXG5lbnVtIERhdGFJZHMge1xyXG4gICAgTmFtZSA9IFwibmFtZVwiLFxyXG4gICAgWFZhbHVlcyA9IFwieFZhbHVlc1wiLFxyXG4gICAgWVZhbHVlcyA9IFwieVZhbHVlc1wiXHJcbn1cclxuXHJcbmNsYXNzIFNpZ25hbFBhY2thZ2VBZGFwdGVyIGltcGxlbWVudHMgSVBhY2thZ2VBZGFwdGVyIHtcclxuICAgIFxyXG5cclxuICAgIC8vbmV3ZXN0IHZlcnNpb24gb2YgdGhlIHBhY2thZ2UgZm9ybWF0XHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IGN1cnJlbnRQYWNrYWdlVmVyc2lvbjogbnVtYmVyID0gMTtcclxuXHJcbiAgICBwcml2YXRlIHNldHRpbmdzVHlwZTogc3RyaW5nO1xyXG4gICAgcHJpdmF0ZSBvYmplY3RUeXBlOiBPYmplY3RUeXBlO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgICAgIHRoaXMuc2V0dGluZ3NUeXBlID0gXCJTaWduYWxcIjtcclxuICAgICAgICB0aGlzLm9iamVjdFR5cGUgPSBPYmplY3RUeXBlLlNJR05BTDtcclxuICAgIH1cclxuICAgIFxyXG4gICAgcGFja2FnZVRvU2V0dGluZyhwYWNrYWdlRGF0YTogSVBhY2thZ2UsIGNvbnRhaW5lcjogRXhwb3J0Q29udGFpbmVyKTogSVNldHRpbmdzIHtcclxuICAgICAgICBcclxuICAgICAgICBsZXQgc2V0dGluZzogSVNldHRpbmdzID0gbmV3IFNldHRpbmdzKHRoaXMuc2V0dGluZ3NUeXBlKTtcclxuXHJcbiAgICAgICAgaWYocGFja2FnZURhdGE/Lm1ldGE/LmRhdGFUeXBlID09IERhdGFUeXBlLk9CSkVDVCAmJiBwYWNrYWdlRGF0YT8ubWV0YT8uW0FkZGl0aW9uYWxNZXRhS2V5cy5PQkpFQ1RUWVBFXSA9PSB0aGlzLm9iamVjdFR5cGUpIHtcclxuICAgICAgICAgICBcclxuICAgICAgICAgICAgc3dpdGNoKHBhY2thZ2VEYXRhPy5tZXRhPy5bQWRkaXRpb25hbE1ldGFLZXlzLlZFUlNJT05dKXsgXHJcbiAgICAgICAgICAgICAgICBjYXNlIDE6XHJcbiAgICAgICAgICAgICAgICAgICAgc2V0dGluZyA9IHRoaXMucGFja2FnZVYxVG9TZXR0aW5nKHBhY2thZ2VEYXRhLCBjb250YWluZXIpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgICAgICB0aHJvdyBNY2VDb252ZXJzaW9uRXJyb3IuY3JlYXRlRXJyb3JCeVR5cGUoTWNlQ29udmVyc2lvbkVycm9yVHlwZS5VTlNVUFBPUlRFRF9WRVJTSU9OLCB0aGlzLm9iamVjdFR5cGUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhyb3cgTWNlQ29udmVyc2lvbkVycm9yLmNyZWF0ZUVycm9yQnlUeXBlKE1jZUNvbnZlcnNpb25FcnJvclR5cGUuVU5TVVBQT1JURURfVFlQRSwgdGhpcy5vYmplY3RUeXBlKTtcclxuICAgICAgICB9ICBcclxuXHJcbiAgICAgICAgcmV0dXJuIHNldHRpbmc7XHJcblxyXG4gICAgfSAgICBcclxuICAgIHByaXZhdGUgcGFja2FnZVYxVG9TZXR0aW5nKHBhY2thZ2VEYXRhOiBJUGFja2FnZSwgY29udGFpbmVyOiBFeHBvcnRDb250YWluZXIpOiBJU2V0dGluZ3Mge1xyXG5cclxuICAgICAgICBsZXQgc2V0dGluZyA9IG5ldyBTZXR0aW5ncyh0aGlzLnNldHRpbmdzVHlwZSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgbGV0IHhWYWx1ZXM6IEFycmF5PG51bWJlcj4gPSBuZXcgQXJyYXkoKTtcclxuICAgICAgICBsZXQgeVZhbHVlczogQXJyYXk8bnVtYmVyPiA9IG5ldyBBcnJheSgpO1xyXG4gICAgICAgIGxldCBwb2ludHM6IEFycmF5PHN0cmluZz4gPSBuZXcgQXJyYXkoKTtcclxuXHJcbiAgICAgICAgaWYocGFja2FnZURhdGE/LmRhdGE/LltEYXRhSWRzLk5hbWVdPy5tZXRhPy5kYXRhVHlwZSA9PSBEYXRhVHlwZS5TVFJJTkcpIHtcclxuICAgICAgICAgICAgc2V0dGluZy5zZXRWYWx1ZShTZXR0aW5nSWRzLk5hbWUsIHBhY2thZ2VEYXRhPy5kYXRhPy5bRGF0YUlkcy5OYW1lXT8uZGF0YSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhyb3cgTWNlQ29udmVyc2lvbkVycm9yLmNyZWF0ZUVycm9yQnlUeXBlKE1jZUNvbnZlcnNpb25FcnJvclR5cGUuTUlTU0lOR19EQVRBLCBEYXRhSWRzLk5hbWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICBpZihwYWNrYWdlRGF0YT8uZGF0YT8uW0RhdGFJZHMuWFZhbHVlc10/Lm1ldGE/LmRhdGFUeXBlID09IERhdGFUeXBlLkFSUkFZICYmIHBhY2thZ2VEYXRhPy5kYXRhPy5bRGF0YUlkcy5YVmFsdWVzXT8ubWV0YT8uW0FkZGl0aW9uYWxNZXRhS2V5cy5BUlJBWVRZUEVdID09IEFycmF5VHlwZS5OVU1CRVIpIHtcclxuICAgICAgICAgICAgeFZhbHVlcyA9IHBhY2thZ2VEYXRhPy5kYXRhPy5bRGF0YUlkcy5YVmFsdWVzXT8uZGF0YTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aHJvdyBNY2VDb252ZXJzaW9uRXJyb3IuY3JlYXRlRXJyb3JCeVR5cGUoTWNlQ29udmVyc2lvbkVycm9yVHlwZS5NSVNTSU5HX0RBVEEsIERhdGFJZHMuWFZhbHVlcyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZihwYWNrYWdlRGF0YT8uZGF0YT8uW0RhdGFJZHMuWVZhbHVlc10/Lm1ldGE/LmRhdGFUeXBlID09IERhdGFUeXBlLkFSUkFZICYmIHBhY2thZ2VEYXRhPy5kYXRhPy5bRGF0YUlkcy5ZVmFsdWVzXT8ubWV0YT8uW0FkZGl0aW9uYWxNZXRhS2V5cy5BUlJBWVRZUEVdID09IEFycmF5VHlwZS5OVU1CRVIpIHtcclxuICAgICAgICAgICAgeVZhbHVlcyA9IHBhY2thZ2VEYXRhPy5kYXRhPy5bRGF0YUlkcy5ZVmFsdWVzXT8uZGF0YTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aHJvdyBNY2VDb252ZXJzaW9uRXJyb3IuY3JlYXRlRXJyb3JCeVR5cGUoTWNlQ29udmVyc2lvbkVycm9yVHlwZS5NSVNTSU5HX0RBVEEsIERhdGFJZHMuWVZhbHVlcyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZih4VmFsdWVzLmxlbmd0aCAhPT0geVZhbHVlcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgdGhyb3cgTWNlQ29udmVyc2lvbkVycm9yLmNyZWF0ZUVycm9yQnlUeXBlKE1jZUNvbnZlcnNpb25FcnJvclR5cGUuTUlTU0lOR19EQVRBLCBgTGVuZ3RoIG9mICR7RGF0YUlkcy5YVmFsdWVzfSBkb2VzIG5vdCBtYXRjaCBsZW5ndGggb2YgJHtEYXRhSWRzLllWYWx1ZXN9YCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIHNldHRpbmcuc2V0VmFsdWUoU2V0dGluZ0lkcy5SYXdQb2ludHNYLCB4VmFsdWVzKTtcclxuICAgICAgICBzZXR0aW5nLnNldFZhbHVlKFNldHRpbmdJZHMuUmF3UG9pbnRzWSwgeVZhbHVlcyk7XHJcblxyXG4gICAgICAgIHJldHVybiBzZXR0aW5nO1xyXG4gICAgfVxyXG4gICAgc2V0dGluZ1RvUGFja2FnZShzZXR0aW5nc0RhdGE6IElTZXR0aW5ncyk6IFBhY2thZ2VBcnJheVdpdGhUb3BMZXZlbElEIHtcclxuXHJcbiAgICAgICAgbGV0IHNldHRpbmdzID0gU2V0dGluZ3MuY3JlYXRlKHNldHRpbmdzRGF0YSk7XHJcblxyXG4gICAgICAgIGxldCBzaWduYWxEYXRhOiB7IFtpbmRleDogc3RyaW5nXTogIElQYWNrYWdlIH0gID0ge307XHJcblxyXG4gICAgICAgIGxldCBwYWNrYWdlU3RydWN0dXJlOiBQYWNrYWdlQXJyYXlXaXRoVG9wTGV2ZWxJRCA9IHtcclxuICAgICAgICAgICAgcGFja2FnZXM6IG5ldyBBcnJheTxJUGFja2FnZT4oKSxcclxuICAgICAgICAgICAgdG9wTGV2ZWxJRDogTmFOXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgaWYoc2V0dGluZ3MudHlwZSA9PT0gdGhpcy5zZXR0aW5nc1R5cGUpIHtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGxldCBpZCA9IE1ldGEuY3JlYXRlSUQoKTtcclxuICAgICAgICAgICAgbGV0IGFkZGl0aW9uYWxNZXRhSW5mbyA9IFt7a2V5OiBBZGRpdGlvbmFsTWV0YUtleXMuT0JKRUNUVFlQRSwgdmFsdWU6IHRoaXMub2JqZWN0VHlwZX0sIHtrZXk6IEFkZGl0aW9uYWxNZXRhS2V5cy5JRCwgdmFsdWU6IGlkfSwge2tleTogQWRkaXRpb25hbE1ldGFLZXlzLlZFUlNJT04sIHZhbHVlOiB0aGlzLmN1cnJlbnRQYWNrYWdlVmVyc2lvbn1dO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgbGV0IHNpZ25hbE1ldGEgPSBuZXcgTWV0YShEYXRhVHlwZS5PQkpFQ1QsIGFkZGl0aW9uYWxNZXRhSW5mbyk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBsZXQgbmFtZURhdGEgPSBzZXR0aW5ncy5nZXRWYWx1ZShTZXR0aW5nSWRzLk5hbWUpO1xyXG4gICAgICAgICAgICBpZihuYW1lRGF0YSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICBzaWduYWxEYXRhW0RhdGFJZHMuTmFtZV0gPSBuZXcgUGFja2FnZShuZXcgTWV0YShEYXRhVHlwZS5TVFJJTkcpLCBuYW1lRGF0YSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBNY2VDb252ZXJzaW9uRXJyb3IuY3JlYXRlRXJyb3JCeVR5cGUoTWNlQ29udmVyc2lvbkVycm9yVHlwZS5NSVNTSU5HX0RBVEEsIFNldHRpbmdJZHMuTmFtZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIC8vIHN1cG9ydCBmb3Igb2xkIHBvaW50cyBkZWZpbml0aW9uIChuZXcgZGVmaW5pdGlvbiBpcyBSYXdQb2ludHNYIGFuZCBSYXdQb2ludHNZKVxyXG4gICAgICAgICAgICBsZXQgcG9pbnREYXRhOiBBcnJheTxzdHJpbmc+ID0gc2V0dGluZ3MuZ2V0VmFsdWUoXCJwb2ludHNcIik7XHJcbiAgICAgICAgICAgIGlmKHBvaW50RGF0YSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICBzaWduYWxEYXRhW0RhdGFJZHMuWFZhbHVlc10gPSBuZXcgUGFja2FnZShuZXcgTWV0YShEYXRhVHlwZS5BUlJBWSwgW3trZXk6IEFkZGl0aW9uYWxNZXRhS2V5cy5BUlJBWVRZUEUsIHZhbHVlOiBBcnJheVR5cGUuTlVNQkVSfV0pLCBwb2ludERhdGEubWFwKChzOiBzdHJpbmcpID0+IHtyZXR1cm4gTnVtYmVyKHMuc3BsaXQoXCI7XCIpWzBdKTt9KSk7XHJcbiAgICAgICAgICAgICAgICBzaWduYWxEYXRhW0RhdGFJZHMuWVZhbHVlc10gPSBuZXcgUGFja2FnZShuZXcgTWV0YShEYXRhVHlwZS5BUlJBWSwgW3trZXk6IEFkZGl0aW9uYWxNZXRhS2V5cy5BUlJBWVRZUEUsIHZhbHVlOiBBcnJheVR5cGUuTlVNQkVSfV0pLCBwb2ludERhdGEubWFwKChzOiBzdHJpbmcpID0+IHtyZXR1cm4gTnVtYmVyKHMuc3BsaXQoXCI7XCIpWzFdKTt9KSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgcmF3UG9pbnRzWDogQXJyYXk8c3RyaW5nPiA9IHNldHRpbmdzLmdldFZhbHVlKFNldHRpbmdJZHMuUmF3UG9pbnRzWCk7XHJcbiAgICAgICAgICAgICAgICBpZihyYXdQb2ludHNYICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICBzaWduYWxEYXRhW0RhdGFJZHMuWFZhbHVlc10gPSBuZXcgUGFja2FnZShuZXcgTWV0YShEYXRhVHlwZS5BUlJBWSwgW3trZXk6IEFkZGl0aW9uYWxNZXRhS2V5cy5BUlJBWVRZUEUsIHZhbHVlOiBBcnJheVR5cGUuTlVNQkVSfV0pLCByYXdQb2ludHNYLm1hcCgoczogc3RyaW5nKSA9PiB7cmV0dXJuIHM7fSkpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB0aHJvdyBNY2VDb252ZXJzaW9uRXJyb3IuY3JlYXRlRXJyb3JCeVR5cGUoTWNlQ29udmVyc2lvbkVycm9yVHlwZS5NSVNTSU5HX0RBVEEsIFNldHRpbmdJZHMuUmF3UG9pbnRzWCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IHJhd1BvaW50c1k6IEFycmF5PHN0cmluZz4gPSBzZXR0aW5ncy5nZXRWYWx1ZShTZXR0aW5nSWRzLlJhd1BvaW50c1kpO1xyXG4gICAgICAgICAgICAgICAgaWYocmF3UG9pbnRzWSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2lnbmFsRGF0YVtEYXRhSWRzLllWYWx1ZXNdID0gbmV3IFBhY2thZ2UobmV3IE1ldGEoRGF0YVR5cGUuQVJSQVksIFt7a2V5OiBBZGRpdGlvbmFsTWV0YUtleXMuQVJSQVlUWVBFLCB2YWx1ZTogQXJyYXlUeXBlLk5VTUJFUn1dKSwgcmF3UG9pbnRzWS5tYXAoKHM6IHN0cmluZykgPT4ge3JldHVybiBzO30pKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgTWNlQ29udmVyc2lvbkVycm9yLmNyZWF0ZUVycm9yQnlUeXBlKE1jZUNvbnZlcnNpb25FcnJvclR5cGUuTUlTU0lOR19EQVRBLCBTZXR0aW5nSWRzLlJhd1BvaW50c1kpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBsZXQgc2lnbmFsUGFja2FnZSA9IG5ldyBQYWNrYWdlKHNpZ25hbE1ldGEsIHNpZ25hbERhdGEpO1xyXG5cclxuICAgICAgICAgICAgcGFja2FnZVN0cnVjdHVyZS5wYWNrYWdlcy5wdXNoKHNpZ25hbFBhY2thZ2UpO1xyXG4gICAgICAgICAgICBwYWNrYWdlU3RydWN0dXJlLnRvcExldmVsSUQgPSBpZDtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aHJvdyBNY2VDb252ZXJzaW9uRXJyb3IuY3JlYXRlRXJyb3JCeVR5cGUoTWNlQ29udmVyc2lvbkVycm9yVHlwZS5VTlNVUFBPUlRFRF9WRVJTSU9OLCB0aGlzLnNldHRpbmdzVHlwZSk7XHJcblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHBhY2thZ2VTdHJ1Y3R1cmU7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCB7IFNpZ25hbFBhY2thZ2VBZGFwdGVyIH0iXX0=