define(["require", "exports", "../../common/packageConversion/enum/objectTypeEnum", "../../common/packageConversion/exportContainer", "../../common/persistence/settings", "../../common/packageConversion/enum/dataTypeEnum", "../../common/packageConversion/enum/additionalMetaKeys", "../../common/packageConversion/mceConversionError", "../../common/packageConversion/enum/arrayTypeEnum", "../../common/packageConversion/meta", "../../common/packageConversion/package"], function (require, exports, objectTypeEnum_1, exportContainer_1, settings_1, dataTypeEnum_1, additionalMetaKeys_1, mceConversionError_1, arrayTypeEnum_1, meta_1, package_1) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    var DataIds;
    (function (DataIds) {
        DataIds["Categories"] = "categories";
    })(DataIds || (DataIds = {}));
    var SignalManagerDataModelPackageAdapter = /** @class */ (function () {
        function SignalManagerDataModelPackageAdapter() {
            //newest version of the package format
            this.currentPackageVersion = 1;
            //define settings key for value categories as there is no SettingIds object provided
            this.categoriesSettingsKey = "categories";
            this.settingsType = "SignalManagerDataModel";
            this.objectType = objectTypeEnum_1.ObjectType.SIGNALMANAGERDATAMODEL;
        }
        SignalManagerDataModelPackageAdapter.prototype.packageToSetting = function (packageData, container) {
            var _a, _b, _c;
            var setting = new settings_1.Settings(this.settingsType);
            if (((_a = packageData === null || packageData === void 0 ? void 0 : packageData.meta) === null || _a === void 0 ? void 0 : _a.dataType) == dataTypeEnum_1.DataType.OBJECT && ((_b = packageData === null || packageData === void 0 ? void 0 : packageData.meta) === null || _b === void 0 ? void 0 : _b[additionalMetaKeys_1.AdditionalMetaKeys.OBJECTTYPE]) == this.objectType) {
                switch ((_c = packageData === null || packageData === void 0 ? void 0 : packageData.meta) === null || _c === void 0 ? void 0 : _c[additionalMetaKeys_1.AdditionalMetaKeys.VERSION]) {
                    case 1:
                        setting = this.packageV1ToSetting(packageData, container);
                        break;
                    default:
                        throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.UNSUPPORTED_VERSION, this.objectType);
                }
            }
            else {
                throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.UNSUPPORTED_TYPE, this.objectType);
            }
            return setting;
        };
        SignalManagerDataModelPackageAdapter.prototype.packageV1ToSetting = function (packageData, container) {
            var _a, _b, _c, _d, _e, _f, _g, _h;
            var setting = new settings_1.Settings(this.settingsType);
            if (((_c = (_b = (_a = packageData === null || packageData === void 0 ? void 0 : packageData.data) === null || _a === void 0 ? void 0 : _a[DataIds.Categories]) === null || _b === void 0 ? void 0 : _b.meta) === null || _c === void 0 ? void 0 : _c.dataType) === dataTypeEnum_1.DataType.ARRAY && ((_f = (_e = (_d = packageData === null || packageData === void 0 ? void 0 : packageData.data) === null || _d === void 0 ? void 0 : _d[DataIds.Categories]) === null || _e === void 0 ? void 0 : _e.meta) === null || _f === void 0 ? void 0 : _f[additionalMetaKeys_1.AdditionalMetaKeys.ARRAYTYPE]) === arrayTypeEnum_1.ArrayType.LINK) {
                var categorySettingsArray_1 = new Array();
                var categoriesData = (_h = (_g = packageData === null || packageData === void 0 ? void 0 : packageData.data) === null || _g === void 0 ? void 0 : _g[DataIds.Categories]) === null || _h === void 0 ? void 0 : _h.data;
                if (categoriesData !== undefined) {
                    categoriesData.forEach(function (id) {
                        var categorySetting = container.getSettingsByID(id);
                        if (categorySetting !== null) {
                            categorySettingsArray_1.push(categorySetting);
                        }
                        else {
                            throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.MISSING_DATA, DataIds.Categories);
                        }
                    });
                    setting.setValue(this.categoriesSettingsKey, categorySettingsArray_1);
                }
                else {
                    throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.MISSING_DATA, DataIds.Categories);
                }
            }
            else {
                throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.MISSING_DATA, DataIds.Categories);
            }
            return setting;
        };
        SignalManagerDataModelPackageAdapter.prototype.settingToPackage = function (settingsData) {
            var _this = this;
            var settings = settings_1.Settings.create(settingsData);
            var signalManagerDataModelData = {};
            var packageStructure = {
                packages: new Array(),
                topLevelID: NaN
            };
            if (settings.type === this.settingsType) {
                var id = meta_1.Meta.createID();
                var additionalMetaInfo = [{ key: additionalMetaKeys_1.AdditionalMetaKeys.OBJECTTYPE, value: this.objectType }, { key: additionalMetaKeys_1.AdditionalMetaKeys.ID, value: id }, { key: additionalMetaKeys_1.AdditionalMetaKeys.VERSION, value: this.currentPackageVersion }];
                var signalManagerDataModelMeta = new meta_1.Meta(dataTypeEnum_1.DataType.OBJECT, additionalMetaInfo);
                var categoriesMeta = new meta_1.Meta(dataTypeEnum_1.DataType.ARRAY, [{ key: additionalMetaKeys_1.AdditionalMetaKeys.ARRAYTYPE, value: arrayTypeEnum_1.ArrayType.LINK }]);
                var categoriesLinks_1 = new Array();
                var categoriesData = settings.getValue(this.categoriesSettingsKey);
                if (categoriesData !== undefined) {
                    categoriesData.forEach(function (settings) {
                        var _a;
                        var categoryPackageStructure = exportContainer_1.ExportContainer.createPackages(settings);
                        if (categoryPackageStructure.packages.length > 0 && !Number.isNaN(categoryPackageStructure.topLevelID)) {
                            categoriesLinks_1.push(categoryPackageStructure.topLevelID);
                            (_a = packageStructure.packages).push.apply(_a, categoryPackageStructure.packages);
                        }
                        else {
                            throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.MISSING_DATA, _this.categoriesSettingsKey);
                        }
                    });
                    signalManagerDataModelData[DataIds.Categories] = new package_1.Package(categoriesMeta, categoriesLinks_1);
                }
                else {
                    throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.MISSING_DATA, this.categoriesSettingsKey);
                }
                var signalManagerDataModelPackage = new package_1.Package(signalManagerDataModelMeta, signalManagerDataModelData);
                packageStructure.packages.push(signalManagerDataModelPackage);
                packageStructure.topLevelID = id;
            }
            else {
                throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.UNSUPPORTED_TYPE, this.settingsType);
            }
            return packageStructure;
        };
        return SignalManagerDataModelPackageAdapter;
    }());
    exports.SignalManagerDataModelPackageAdapter = SignalManagerDataModelPackageAdapter;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2lnbmFsTWFuYWdlckRhdGFNb2RlbFBhY2thZ2VBZGFwdGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL2FwcC9tb2RlbHMvc2lnbmFsTWFuYWdlckRhdGFNb2RlbC9zaWduYWxNYW5hZ2VyRGF0YU1vZGVsUGFja2FnZUFkYXB0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0lBY0EsSUFBSyxPQUVKO0lBRkQsV0FBSyxPQUFPO1FBQ1Isb0NBQXlCLENBQUE7SUFDN0IsQ0FBQyxFQUZJLE9BQU8sS0FBUCxPQUFPLFFBRVg7SUFFRDtRQVdJO1lBVEEsc0NBQXNDO1lBQ3JCLDBCQUFxQixHQUFXLENBQUMsQ0FBQztZQUVuRCxvRkFBb0Y7WUFDbkUsMEJBQXFCLEdBQUcsWUFBWSxDQUFBO1lBTWpELElBQUksQ0FBQyxZQUFZLEdBQUcsd0JBQXdCLENBQUM7WUFDN0MsSUFBSSxDQUFDLFVBQVUsR0FBRywyQkFBVSxDQUFDLHNCQUFzQixDQUFDO1FBQ3hELENBQUM7UUFFRCwrREFBZ0IsR0FBaEIsVUFBaUIsV0FBcUIsRUFBRSxTQUEwQjs7WUFFOUQsSUFBSSxPQUFPLEdBQWMsSUFBSSxtQkFBUSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUV6RCxJQUFHLE9BQUEsV0FBVyxhQUFYLFdBQVcsdUJBQVgsV0FBVyxDQUFFLElBQUksMENBQUUsUUFBUSxLQUFJLHVCQUFRLENBQUMsTUFBTSxJQUFJLE9BQUEsV0FBVyxhQUFYLFdBQVcsdUJBQVgsV0FBVyxDQUFFLElBQUksMENBQUcsdUNBQWtCLENBQUMsVUFBVSxNQUFLLElBQUksQ0FBQyxVQUFVLEVBQUU7Z0JBRXhILGNBQU8sV0FBVyxhQUFYLFdBQVcsdUJBQVgsV0FBVyxDQUFFLElBQUksMENBQUcsdUNBQWtCLENBQUMsT0FBTyxHQUFFO29CQUNuRCxLQUFLLENBQUM7d0JBQ0YsT0FBTyxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxXQUFX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QVksRUFBRSxLQUFJLENBQUMscUJBQXFCLENBQUMsQ0FBQzt5QkFDL0c7b0JBQ0wsQ0FBQyxDQUFDLENBQUM7b0JBQ0gsMEJBQTBCLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxHQUFHLElBQUksaUJBQU8sQ0FBQyxjQUFjLEVBQUUsaUJBQWUsQ0FBQyxDQUFDO2lCQUNqRztxQkFBTTtvQkFDSCxNQUFNLHVDQUFrQixDQUFDLGlCQUFpQixDQUFDLDJDQUFzQixDQUFDLFlBQVksRUFBRSxJQUFJLENBQUMscUJBQXFCLENBQUMsQ0FBQztpQkFDL0c7Z0JBR0QsSUFBSSw2QkFBNkIsR0FBRyxJQUFJLGlCQUFPLENBQUMsMEJBQTBCLEVBQUUsMEJBQTBCLENBQUMsQ0FBQztnQkFFeEcsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyw2QkFBNkIsQ0FBQyxDQUFDO2dCQUM5RCxnQkFBZ0IsQ0FBQyxVQUFVLEdBQUcsRUFBRSxDQUFDO2FBQ3BDO2lCQUFNO2dCQUNILE1BQU0sdUNBQWtCLENBQUMsaUJBQWlCLENBQUMsMkNBQXNCLENBQUMsZ0JBQWdCLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO2FBQzFHO1lBRUQsT0FBTyxnQkFBZ0IsQ0FBQztRQUM1QixDQUFDO1FBQ0wsMkNBQUM7SUFBRCxDQUFDLEFBN0dELElBNkdDO0lBRVEsb0ZBQW9DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSVBhY2thZ2VBZGFwdGVyLCBQYWNrYWdlQXJyYXlXaXRoVG9wTGV2ZWxJRCB9IGZyb20gXCIuLi8uLi9jb21tb24vcGFja2FnZUNvbnZlcnNpb24vaW50ZXJmYWNlL3BhY2thZ2VBZGFwdGVySW50ZXJmYWNlXCI7XHJcbmltcG9ydCB7IE9iamVjdFR5cGUgfSBmcm9tIFwiLi4vLi4vY29tbW9uL3BhY2thZ2VDb252ZXJzaW9uL2VudW0vb2JqZWN0VHlwZUVudW1cIjtcclxuaW1wb3J0IHsgSVBhY2thZ2UgfSBmcm9tIFwiLi4vLi4vY29tbW9uL3BhY2thZ2VDb252ZXJzaW9uL2ludGVyZmFjZS9wYWNrYWdlSW50ZXJmYWNlXCI7XHJcbmltcG9ydCB7IEV4cG9ydENvbnRhaW5lciB9IGZyb20gXCIuLi8uLi9jb21tb24vcGFja2FnZUNvbnZlcnNpb24vZXhwb3J0Q29udGFpbmVyXCI7XHJcbmltcG9ydCB7IElTZXR0aW5ncyB9IGZyb20gXCIuLi8uLi9jb21tb24vcGVyc2lzdGVuY2UvaW50ZXJmYWNlcy9zZXR0aW5nc0ludGVyZmFjZVwiO1xyXG5pbXBvcnQgeyBTZXR0aW5ncyB9IGZyb20gXCIuLi8uLi9jb21tb24vcGVyc2lzdGVuY2Uvc2V0dGluZ3NcIjtcclxuaW1wb3J0IHsgRGF0YVR5cGUgfSBmcm9tIFwiLi4vLi4vY29tbW9uL3BhY2thZ2VDb252ZXJzaW9uL2VudW0vZGF0YVR5cGVFbnVtXCI7XHJcbmltcG9ydCB7IEFkZGl0aW9uYWxNZXRhS2V5cyB9IGZyb20gXCIuLi8uLi9jb21tb24vcGFja2FnZUNvbnZlcnNpb24vZW51bS9hZGRpdGlvbmFsTWV0YUtleXNcIjtcclxuaW1wb3J0IHsgTWNlQ29udmVyc2lvbkVycm9yLCBNY2VDb252ZXJzaW9uRXJyb3JUeXBlIH0gZnJvbSBcIi4uLy4uL2NvbW1vbi9wYWNrYWdlQ29udmVyc2lvbi9tY2VDb252ZXJzaW9uRXJyb3JcIjtcclxuaW1wb3J0IHsgQXJyYXlUeXBlIH0gZnJvbSBcIi4uLy4uL2NvbW1vbi9wYWNrYWdlQ29udmVyc2lvbi9lbnVtL2FycmF5VHlwZUVudW1cIjtcclxuaW1wb3J0IHsgTWV0YSB9IGZyb20gXCIuLi8uLi9jb21tb24vcGFja2FnZUNvbnZlcnNpb24vbWV0YVwiO1xyXG5pbXBvcnQgeyBQYWNrYWdlIH0gZnJvbSBcIi4uLy4uL2NvbW1vbi9wYWNrYWdlQ29udmVyc2lvbi9wYWNrYWdlXCI7XHJcblxyXG5cclxuZW51bSBEYXRhSWRzIHtcclxuICAgIENhdGVnb3JpZXMgPSBcImNhdGVnb3JpZXNcIlxyXG59XHJcblxyXG5jbGFzcyBTaWduYWxNYW5hZ2VyRGF0YU1vZGVsUGFja2FnZUFkYXB0ZXIgaW1wbGVtZW50cyBJUGFja2FnZUFkYXB0ZXIge1xyXG5cclxuICAgIC8vbmV3ZXN0IHZlcnNpb24gb2YgdGhlIHBhY2thZ2UgZm9ybWF0XHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IGN1cnJlbnRQYWNrYWdlVmVyc2lvbjogbnVtYmVyID0gMTtcclxuXHJcbiAgICAvL2RlZmluZSBzZXR0aW5ncyBrZXkgZm9yIHZhbHVlIGNhdGVnb3JpZXMgYXMgdGhlcmUgaXMgbm8gU2V0dGluZ0lkcyBvYmplY3QgcHJvdmlkZWRcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgY2F0ZWdvcmllc1NldHRpbmdzS2V5ID0gXCJjYXRlZ29yaWVzXCJcclxuXHJcbiAgICBwcml2YXRlIHNldHRpbmdzVHlwZTogc3RyaW5nO1xyXG4gICAgcHJpdmF0ZSBvYmplY3RUeXBlOiBPYmplY3RUeXBlO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgICAgIHRoaXMuc2V0dGluZ3NUeXBlID0gXCJTaWduYWxNYW5hZ2VyRGF0YU1vZGVsXCI7XHJcbiAgICAgICAgdGhpcy5vYmplY3RUeXBlID0gT2JqZWN0VHlwZS5TSUdOQUxNQU5BR0VSREFUQU1PREVMO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBwYWNrYWdlVG9TZXR0aW5nKHBhY2thZ2VEYXRhOiBJUGFja2FnZSwgY29udGFpbmVyOiBFeHBvcnRDb250YWluZXIpOiBJU2V0dGluZ3Mge1xyXG4gICAgICAgIFxyXG4gICAgICAgIGxldCBzZXR0aW5nOiBJU2V0dGluZ3MgPSBuZXcgU2V0dGluZ3ModGhpcy5zZXR0aW5nc1R5cGUpO1xyXG5cclxuICAgICAgICBpZihwYWNrYWdlRGF0YT8ubWV0YT8uZGF0YVR5cGUgPT0gRGF0YVR5cGUuT0JKRUNUICYmIHBhY2thZ2VEYXRhPy5tZXRhPy5bQWRkaXRpb25hbE1ldGFLZXlzLk9CSkVDVFRZUEVdID09IHRoaXMub2JqZWN0VHlwZSkge1xyXG4gICAgICAgIFxyXG4gICAgICAgICAgICBzd2l0Y2gocGFja2FnZURhdGE/Lm1ldGE/LltBZGRpdGlvbmFsTWV0YUtleXMuVkVSU0lPTl0peyBcclxuICAgICAgICAgICAgICAgIGNhc2UgMTpcclxuICAgICAgICAgICAgICAgICAgICBzZXR0aW5nID0gdGhpcy5wYWNrYWdlVjFUb1NldHRpbmcocGFja2FnZURhdGEsIGNvbnRhaW5lcik7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgICAgIHRocm93IE1jZUNvbnZlcnNpb25FcnJvci5jcmVhdGVFcnJvckJ5VHlwZShNY2VDb252ZXJzaW9uRXJyb3JUeXBlLlVOU1VQUE9SVEVEX1ZFUlNJT04sIHRoaXMub2JqZWN0VHlwZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aHJvdyBNY2VDb252ZXJzaW9uRXJyb3IuY3JlYXRlRXJyb3JCeVR5cGUoTWNlQ29udmVyc2lvbkVycm9yVHlwZS5VTlNVUFBPUlRFRF9UWVBFLCB0aGlzLm9iamVjdFR5cGUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gc2V0dGluZztcclxuICAgIH0gICAgXHJcblxyXG4gICAgcHJpdmF0ZSBwYWNrYWdlVjFUb1NldHRpbmcocGFja2FnZURhdGE6IElQYWNrYWdlLCBjb250YWluZXI6IEV4cG9ydENvbnRhaW5lcik6IElTZXR0aW5ncyB7XHJcblxyXG4gICAgICAgIGxldCBzZXR0aW5nID0gbmV3IFNldHRpbmdzKHRoaXMuc2V0dGluZ3NUeXBlKTtcclxuXHJcbiAgICAgICAgaWYocGFja2FnZURhdGE/LmRhdGE/LltEYXRhSWRzLkNhdGVnb3JpZXNdPy5tZXRhPy5kYXRhVHlwZSA9PT0gRGF0YVR5cGUuQVJSQVkgJiYgcGFja2FnZURhdGE/LmRhdGE/LltEYXRhSWRzLkNhdGVnb3JpZXNdPy5tZXRhPy5bQWRkaXRpb25hbE1ldGFLZXlzLkFSUkFZVFlQRV0gPT09IEFycmF5VHlwZS5MSU5LKSB7XHJcbiAgICAgICAgICAgIGxldCBjYXRlZ29yeVNldHRpbmdzQXJyYXkgPSBuZXcgQXJyYXk8SVNldHRpbmdzPigpO1xyXG5cclxuICAgICAgICAgICAgbGV0IGNhdGVnb3JpZXNEYXRhOiBBcnJheTxudW1iZXI+ID0gcGFja2FnZURhdGE/LmRhdGE/LltEYXRhSWRzLkNhdGVnb3JpZXNdPy5kYXRhO1xyXG4gICAgICAgICAgICBpZihjYXRlZ29yaWVzRGF0YSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICBjYXRlZ29yaWVzRGF0YS5mb3JFYWNoKChpZCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBjYXRlZ29yeVNldHRpbmcgPSBjb250YWluZXIuZ2V0U2V0dGluZ3NCeUlEKGlkKTtcclxuICAgICAgICAgICAgICAgICAgICBpZihjYXRlZ29yeVNldHRpbmcgIT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2F0ZWdvcnlTZXR0aW5nc0FycmF5LnB1c2goY2F0ZWdvcnlTZXR0aW5nKTtcclxuICAgICAgICAgICAgICAgICAgICB9ZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IE1jZUNvbnZlcnNpb25FcnJvci5jcmVhdGVFcnJvckJ5VHlwZShNY2VDb252ZXJzaW9uRXJyb3JUeXBlLk1JU1NJTkdfREFUQSwgRGF0YUlkcy5DYXRlZ29yaWVzKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIHNldHRpbmcuc2V0VmFsdWUodGhpcy5jYXRlZ29yaWVzU2V0dGluZ3NLZXksIGNhdGVnb3J5U2V0dGluZ3NBcnJheSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBNY2VDb252ZXJzaW9uRXJyb3IuY3JlYXRlRXJyb3JCeVR5cGUoTWNlQ29udmVyc2lvbkVycm9yVHlwZS5NSVNTSU5HX0RBVEEsIERhdGFJZHMuQ2F0ZWdvcmllcyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgXHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhyb3cgTWNlQ29udmVyc2lvbkVycm9yLmNyZWF0ZUVycm9yQnlUeXBlKE1jZUNvbnZlcnNpb25FcnJvclR5cGUuTUlTU0lOR19EQVRBLCBEYXRhSWRzLkNhdGVnb3JpZXMpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHNldHRpbmc7XHJcbiAgICB9XHJcbiAgICBzZXR0aW5nVG9QYWNrYWdlKHNldHRpbmdzRGF0YTogSVNldHRpbmdzKTogUGFja2FnZUFycmF5V2l0aFRvcExldmVsSUQge1xyXG4gICAgICAgIFxyXG4gICAgICAgIGxldCBzZXR0aW5ncyA9IFNldHRpbmdzLmNyZWF0ZShzZXR0aW5nc0RhdGEpO1xyXG5cclxuICAgICAgICBsZXQgc2lnbmFsTWFuYWdlckRhdGFNb2RlbERhdGE6IHsgW2luZGV4OiBzdHJpbmddOiAgSVBhY2thZ2UgfSAgPSB7fTtcclxuXHJcbiAgICAgICAgbGV0IHBhY2thZ2VTdHJ1Y3R1cmU6IFBhY2thZ2VBcnJheVdpdGhUb3BMZXZlbElEID0ge1xyXG4gICAgICAgICAgICBwYWNrYWdlczogbmV3IEFycmF5PElQYWNrYWdlPigpLFxyXG4gICAgICAgICAgICB0b3BMZXZlbElEOiBOYU5cclxuICAgICAgICB9O1xyXG4gICAgICAgIGlmKHNldHRpbmdzLnR5cGUgPT09IHRoaXMuc2V0dGluZ3NUeXBlKSB7XHJcblxyXG4gICAgICAgICAgICBsZXQgaWQgPSBNZXRhLmNyZWF0ZUlEKCk7XHJcbiAgICAgICAgICAgIGxldCBhZGRpdGlvbmFsTWV0YUluZm8gPSBbe2tleTogQWRkaXRpb25hbE1ldGFLZXlzLk9CSkVDVFRZUEUsIHZhbHVlOiB0aGlzLm9iamVjdFR5cGV9LCB7a2V5OiBBZGRpdGlvbmFsTWV0YUtleXMuSUQsIHZhbHVlOiBpZH0sIHtrZXk6IEFkZGl0aW9uYWxNZXRhS2V5cy5WRVJTSU9OLCB2YWx1ZTogdGhpcy5jdXJyZW50UGFja2FnZVZlcnNpb259XTtcclxuICAgICAgICAgICAgbGV0IHNpZ25hbE1hbmFnZXJEYXRhTW9kZWxNZXRhID0gbmV3IE1ldGEoRGF0YVR5cGUuT0JKRUNULCBhZGRpdGlvbmFsTWV0YUluZm8pO1xyXG4gICAgICAgICAgICBsZXQgY2F0ZWdvcmllc01ldGEgPSBuZXcgTWV0YShEYXRhVHlwZS5BUlJBWSwgW3trZXk6IEFkZGl0aW9uYWxNZXRhS2V5cy5BUlJBWVRZUEUsIHZhbHVlOiBBcnJheVR5cGUuTElOS31dKTtcclxuICAgICAgICAgICAgbGV0IGNhdGVnb3JpZXNMaW5rcyA9IG5ldyBBcnJheTxudW1iZXI+KCk7XHJcblxyXG4gICAgICAgICAgICBsZXQgY2F0ZWdvcmllc0RhdGE6IEFycmF5PElTZXR0aW5ncz4gPSBzZXR0aW5ncy5nZXRWYWx1ZSh0aGlzLmNhdGVnb3JpZXNTZXR0aW5nc0tleSk7XHJcbiAgICAgICAgICAgIGlmKGNhdGVnb3JpZXNEYXRhICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIGNhdGVnb3JpZXNEYXRhLmZvckVhY2goKHNldHRpbmdzKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IGNhdGVnb3J5UGFja2FnZVN0cnVjdHVyZSA9IEV4cG9ydENvbnRhaW5lci5jcmVhdGVQYWNrYWdlcyhzZXR0aW5ncyk7XHJcbiAgICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgaWYoY2F0ZWdvcnlQYWNrYWdlU3RydWN0dXJlLnBhY2thZ2VzLmxlbmd0aCA+IDAgJiYgIU51bWJlci5pc05hTihjYXRlZ29yeVBhY2thZ2VTdHJ1Y3R1cmUudG9wTGV2ZWxJRCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2F0ZWdvcmllc0xpbmtzLnB1c2goY2F0ZWdvcnlQYWNrYWdlU3RydWN0dXJlLnRvcExldmVsSUQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwYWNrYWdlU3RydWN0dXJlLnBhY2thZ2VzLnB1c2goLi4uY2F0ZWdvcnlQYWNrYWdlU3RydWN0dXJlLnBhY2thZ2VzKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBNY2VDb252ZXJzaW9uRXJyb3IuY3JlYXRlRXJyb3JCeVR5cGUoTWNlQ29udmVyc2lvbkVycm9yVHlwZS5NSVNTSU5HX0RBVEEsIHRoaXMuY2F0ZWdvcmllc1NldHRpbmdzS2V5KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIHNpZ25hbE1hbmFnZXJEYXRhTW9kZWxEYXRhW0RhdGFJZHMuQ2F0ZWdvcmllc10gPSBuZXcgUGFja2FnZShjYXRlZ29yaWVzTWV0YSwgY2F0ZWdvcmllc0xpbmtzKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRocm93IE1jZUNvbnZlcnNpb25FcnJvci5jcmVhdGVFcnJvckJ5VHlwZShNY2VDb252ZXJzaW9uRXJyb3JUeXBlLk1JU1NJTkdfREFUQSwgdGhpcy5jYXRlZ29yaWVzU2V0dGluZ3NLZXkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIFxyXG5cclxuICAgICAgICAgICAgbGV0IHNpZ25hbE1hbmFnZXJEYXRhTW9kZWxQYWNrYWdlID0gbmV3IFBhY2thZ2Uoc2lnbmFsTWFuYWdlckRhdGFNb2RlbE1ldGEsIHNpZ25hbE1hbmFnZXJEYXRhTW9kZWxEYXRhKTtcclxuXHJcbiAgICAgICAgICAgIHBhY2thZ2VTdHJ1Y3R1cmUucGFja2FnZXMucHVzaChzaWduYWxNYW5hZ2VyRGF0YU1vZGVsUGFja2FnZSk7XHJcbiAgICAgICAgICAgIHBhY2thZ2VTdHJ1Y3R1cmUudG9wTGV2ZWxJRCA9IGlkO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRocm93IE1jZUNvbnZlcnNpb25FcnJvci5jcmVhdGVFcnJvckJ5VHlwZShNY2VDb252ZXJzaW9uRXJyb3JUeXBlLlVOU1VQUE9SVEVEX1RZUEUsIHRoaXMuc2V0dGluZ3NUeXBlKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBwYWNrYWdlU3RydWN0dXJlO1xyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgeyBTaWduYWxNYW5hZ2VyRGF0YU1vZGVsUGFja2FnZUFkYXB0ZXIgfSJdfQ==