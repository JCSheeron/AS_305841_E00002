define(["require", "exports", "../../common/packageConversion/enum/objectTypeEnum", "../../common/packageConversion/exportContainer", "../../common/persistence/settings", "../../common/packageConversion/enum/dataTypeEnum", "../../common/packageConversion/enum/additionalMetaKeys", "../../common/packageConversion/mceConversionError", "./signalManagerDataModelSettingIds", "../../common/packageConversion/enum/arrayTypeEnum", "../../common/packageConversion/package", "../../common/packageConversion/meta"], function (require, exports, objectTypeEnum_1, exportContainer_1, settings_1, dataTypeEnum_1, additionalMetaKeys_1, mceConversionError_1, signalManagerDataModelSettingIds_1, arrayTypeEnum_1, package_1, meta_1) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    var DataIds;
    (function (DataIds) {
        DataIds["SerieGroups"] = "serieGroups";
        DataIds["CategoryId"] = "id";
    })(DataIds || (DataIds = {}));
    var CategoryPackageAdapter = /** @class */ (function () {
        function CategoryPackageAdapter() {
            //newest version of package format
            this.currentPackageVersion = 1;
            this.settingsType = "category";
            this.objectType = objectTypeEnum_1.ObjectType.CATEGORY;
        }
        CategoryPackageAdapter.prototype.packageToSetting = function (packageData, container) {
            var _a, _b, _c;
            var setting = new settings_1.Settings(this.settingsType);
            if (((_a = packageData === null || packageData === void 0 ? void 0 : packageData.meta) === null || _a === void 0 ? void 0 : _a.dataType) === dataTypeEnum_1.DataType.OBJECT && ((_b = packageData === null || packageData === void 0 ? void 0 : packageData.meta) === null || _b === void 0 ? void 0 : _b[additionalMetaKeys_1.AdditionalMetaKeys.OBJECTTYPE]) === this.objectType) {
                switch ((_c = packageData === null || packageData === void 0 ? void 0 : packageData.meta) === null || _c === void 0 ? void 0 : _c[additionalMetaKeys_1.AdditionalMetaKeys.VERSION]) {
                    case 1:
                        setting = this.packageV1ToSetting(packageData, container);
                        break;
                    default:
                        throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.UNSUPPORTED_VERSION, this.objectType);
                }
            }
            else {
                throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.UNSUPPORTED_TYPE, this.objectType);
            }
            return setting;
        };
        CategoryPackageAdapter.prototype.packageV1ToSetting = function (packageData, container) {
            var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k, _l, _m, _o;
            var setting = new settings_1.Settings(this.settingsType);
            if (((_c = (_b = (_a = packageData === null || packageData === void 0 ? void 0 : packageData.data) === null || _a === void 0 ? void 0 : _a[DataIds.CategoryId]) === null || _b === void 0 ? void 0 : _b.meta) === null || _c === void 0 ? void 0 : _c.dataType) === dataTypeEnum_1.DataType.STRING) {
                setting.setValue(signalManagerDataModelSettingIds_1.SettingIds.CategoryId, (_e = (_d = packageData === null || packageData === void 0 ? void 0 : packageData.data) === null || _d === void 0 ? void 0 : _d[DataIds.CategoryId]) === null || _e === void 0 ? void 0 : _e.data);
            }
            else {
                throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.MISSING_DATA, DataIds.CategoryId);
                ;
            }
            if (((_h = (_g = (_f = packageData === null || packageData === void 0 ? void 0 : packageData.data) === null || _f === void 0 ? void 0 : _f[DataIds.SerieGroups]) === null || _g === void 0 ? void 0 : _g.meta) === null || _h === void 0 ? void 0 : _h.dataType) === dataTypeEnum_1.DataType.ARRAY && ((_l = (_k = (_j = packageData === null || packageData === void 0 ? void 0 : packageData.data) === null || _j === void 0 ? void 0 : _j[DataIds.SerieGroups]) === null || _k === void 0 ? void 0 : _k.meta) === null || _l === void 0 ? void 0 : _l[additionalMetaKeys_1.AdditionalMetaKeys.ARRAYTYPE]) === arrayTypeEnum_1.ArrayType.LINK) {
                var serieGroupSettings_1 = new Array();
                var linkArray = (_o = (_m = packageData === null || packageData === void 0 ? void 0 : packageData.data) === null || _m === void 0 ? void 0 : _m[DataIds.SerieGroups]) === null || _o === void 0 ? void 0 : _o.data;
                if (linkArray !== undefined) {
                    linkArray.forEach(function (id) {
                        var serieGroupSetting = container.getSettingsByID(id);
                        if (serieGroupSetting !== null) {
                            serieGroupSettings_1.push(serieGroupSetting);
                        }
                        else {
                            throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.MISSING_DATA, DataIds.SerieGroups);
                        }
                    });
                }
                else {
                    throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.MISSING_DATA, DataIds.SerieGroups);
                }
                setting.setValue(signalManagerDataModelSettingIds_1.SettingIds.SerieGroups, serieGroupSettings_1);
            }
            else {
                throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.MISSING_DATA, DataIds.SerieGroups);
            }
            return setting;
        };
        CategoryPackageAdapter.prototype.settingToPackage = function (settingsData) {
            var settings = settings_1.Settings.create(settingsData);
            var categoryData = {};
            var packageStructure = {
                packages: new Array(),
                topLevelID: NaN
            };
            if (settings.type === this.settingsType) {
                var id = meta_1.Meta.createID();
                var additionalMetaKeys = [{ key: additionalMetaKeys_1.AdditionalMetaKeys.OBJECTTYPE, value: this.objectType }, { key: additionalMetaKeys_1.AdditionalMetaKeys.ID, value: id }, { key: additionalMetaKeys_1.AdditionalMetaKeys.VERSION, value: this.currentPackageVersion }];
                var categoryMeta = new meta_1.Meta(dataTypeEnum_1.DataType.OBJECT, additionalMetaKeys);
                var serieGroupsMeta = new meta_1.Meta(dataTypeEnum_1.DataType.ARRAY, [{ key: additionalMetaKeys_1.AdditionalMetaKeys.ARRAYTYPE, value: arrayTypeEnum_1.ArrayType.LINK }]);
                var serieGroupsLinks_1 = new Array();
                var serieGroupsData = settings.getValue(signalManagerDataModelSettingIds_1.SettingIds.SerieGroups);
                if (serieGroupsData !== undefined) {
                    serieGroupsData.forEach(function (serieGroupSetting) {
                        var _a;
                        var serieGroupPackageStructure = exportContainer_1.ExportContainer.createPackages(serieGroupSetting);
                        if (serieGroupPackageStructure.packages.length > 0 && !Number.isNaN(serieGroupPackageStructure.topLevelID)) {
                            serieGroupsLinks_1.push(serieGroupPackageStructure.topLevelID);
                            (_a = packageStructure.packages).push.apply(_a, serieGroupPackageStructure.packages);
                        }
                    });
                    categoryData[DataIds.SerieGroups] = new package_1.Package(serieGroupsMeta, serieGroupsLinks_1);
                }
                else {
                    throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.MISSING_DATA, signalManagerDataModelSettingIds_1.SettingIds.SerieGroups);
                }
                var categoryIdData = settings.getValue(signalManagerDataModelSettingIds_1.SettingIds.CategoryId);
                if (categoryIdData !== undefined) {
                    categoryData[DataIds.CategoryId] = new package_1.Package(new meta_1.Meta(dataTypeEnum_1.DataType.STRING), categoryIdData);
                }
                else {
                    throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.MISSING_DATA, signalManagerDataModelSettingIds_1.SettingIds.CategoryId);
                }
                var categoryPackage = new package_1.Package(categoryMeta, categoryData);
                packageStructure.packages.push(categoryPackage);
                packageStructure.topLevelID = id;
            }
            else {
                throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.UNSUPPORTED_VERSION, this.settingsType);
            }
            return packageStructure;
        };
        return CategoryPackageAdapter;
    }());
    exports.CategoryPackageAdapter = CategoryPackageAdapter;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2F0ZWdvcnlQYWNrYWdlQWRhcHRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9hcHAvbW9kZWxzL3NpZ25hbE1hbmFnZXJEYXRhTW9kZWwvY2F0ZWdvcnlQYWNrYWdlQWRhcHRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7SUFlQSxJQUFLLE9BR0o7SUFIRCxXQUFLLE9BQU87UUFDUixzQ0FBMkIsQ0FBQTtRQUMzQiw0QkFBaUIsQ0FBQTtJQUNyQixDQUFDLEVBSEksT0FBTyxLQUFQLE9BQU8sUUFHWDtJQUVEO1FBUUk7WUFOQSxrQ0FBa0M7WUFDakIsMEJBQXFCLEdBQVcsQ0FBQyxDQUFDO1lBTS9DLElBQUksQ0FBQyxZQUFZLEdBQUcsVUFBVSxDQUFDO1lBQy9CLElBQUksQ0FBQyxVQUFVLEdBQUcsMkJBQVUsQ0FBQyxRQUFRLENBQUM7UUFDMUMsQ0FBQztRQUNELGlEQUFnQixHQUFoQixVQUFpQixXQUFxQixFQUFFLFNBQTBCOztZQUU5RCxJQUFJLE9BQU8sR0FBYyxJQUFJLG1CQUFRLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBRXpELElBQUcsT0FBQSxXQUFXLGFBQVgsV0FBVyx1QkFBWCxXQUFXLENBQUUsSUFBSSwwQ0FBRSxRQUFRLE1BQUssdUJBQVEsQ0FBQyxNQUFNLElBQUksT0FBQSxXQUFXLGFBQVgsV0FBVyx1QkFBWCxXQUFXLENBQUUsSUFBSSwwQ0FBRyx1Q0FBa0IsQ0FBQyxVQUFVLE9BQU0sSUFBSSxDQUFDLFVBQVUsRUFBRTtnQkFFMUgsY0FBTyxXQUFXLGFBQVgsV0FBVyx1QkFBWCxXQUFXLENBQUUsSUFBSSwwQ0FBRyx1Q0FBa0IsQ0FBQyxPQUFPLEdBQUU7b0JBQ25ELEtBQUssQ0FBQzt3QkFDRixPQUFPLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFdBQVcsRUFBRSxTQUFTLENBQUMsQ0FBQzt3QkFDMUQsTUFBTTtvQkFDVjt3QkFFSixNQUFNLHVDQUFr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VUFBVSxHQUFHLEVBQUUsQ0FBQzthQUNwQztpQkFBTTtnQkFDSCxNQUFNLHVDQUFrQixDQUFDLGlCQUFpQixDQUFDLDJDQUFzQixDQUFDLG1CQUFtQixFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQzthQUM3RztZQUVELE9BQU8sZ0JBQWdCLENBQUM7UUFDNUIsQ0FBQztRQUNMLDZCQUFDO0lBQUQsQ0FBQyxBQXRIRCxJQXNIQztJQUVRLHdEQUFzQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IElQYWNrYWdlQWRhcHRlciwgUGFja2FnZUFycmF5V2l0aFRvcExldmVsSUQgfSBmcm9tIFwiLi4vLi4vY29tbW9uL3BhY2thZ2VDb252ZXJzaW9uL2ludGVyZmFjZS9wYWNrYWdlQWRhcHRlckludGVyZmFjZVwiO1xyXG5pbXBvcnQgeyBPYmplY3RUeXBlIH0gZnJvbSBcIi4uLy4uL2NvbW1vbi9wYWNrYWdlQ29udmVyc2lvbi9lbnVtL29iamVjdFR5cGVFbnVtXCI7XHJcbmltcG9ydCB7IElQYWNrYWdlIH0gZnJvbSBcIi4uLy4uL2NvbW1vbi9wYWNrYWdlQ29udmVyc2lvbi9pbnRlcmZhY2UvcGFja2FnZUludGVyZmFjZVwiO1xyXG5pbXBvcnQgeyBFeHBvcnRDb250YWluZXIgfSBmcm9tIFwiLi4vLi4vY29tbW9uL3BhY2thZ2VDb252ZXJzaW9uL2V4cG9ydENvbnRhaW5lclwiO1xyXG5pbXBvcnQgeyBJU2V0dGluZ3MgfSBmcm9tIFwiLi4vLi4vY29tbW9uL3BlcnNpc3RlbmNlL2ludGVyZmFjZXMvc2V0dGluZ3NJbnRlcmZhY2VcIjtcclxuaW1wb3J0IHsgU2V0dGluZ3MgfSBmcm9tIFwiLi4vLi4vY29tbW9uL3BlcnNpc3RlbmNlL3NldHRpbmdzXCI7XHJcbmltcG9ydCB7IERhdGFUeXBlIH0gZnJvbSBcIi4uLy4uL2NvbW1vbi9wYWNrYWdlQ29udmVyc2lvbi9lbnVtL2RhdGFUeXBlRW51bVwiO1xyXG5pbXBvcnQgeyBBZGRpdGlvbmFsTWV0YUtleXMgfSBmcm9tIFwiLi4vLi4vY29tbW9uL3BhY2thZ2VDb252ZXJzaW9uL2VudW0vYWRkaXRpb25hbE1ldGFLZXlzXCI7XHJcbmltcG9ydCB7IE1jZUNvbnZlcnNpb25FcnJvciwgTWNlQ29udmVyc2lvbkVycm9yVHlwZSB9IGZyb20gXCIuLi8uLi9jb21tb24vcGFja2FnZUNvbnZlcnNpb24vbWNlQ29udmVyc2lvbkVycm9yXCI7XHJcbmltcG9ydCB7IFNldHRpbmdJZHMgfSBmcm9tIFwiLi9zaWduYWxNYW5hZ2VyRGF0YU1vZGVsU2V0dGluZ0lkc1wiO1xyXG5pbXBvcnQgeyBBcnJheVR5cGUgfSBmcm9tIFwiLi4vLi4vY29tbW9uL3BhY2thZ2VDb252ZXJzaW9uL2VudW0vYXJyYXlUeXBlRW51bVwiO1xyXG5pbXBvcnQgeyBQYWNrYWdlIH0gZnJvbSBcIi4uLy4uL2NvbW1vbi9wYWNrYWdlQ29udmVyc2lvbi9wYWNrYWdlXCI7XHJcbmltcG9ydCB7IE1ldGEgfSBmcm9tIFwiLi4vLi4vY29tbW9uL3BhY2thZ2VDb252ZXJzaW9uL21ldGFcIjtcclxuXHJcblxyXG5lbnVtIERhdGFJZHMge1xyXG4gICAgU2VyaWVHcm91cHMgPSBcInNlcmllR3JvdXBzXCIsXHJcbiAgICBDYXRlZ29yeUlkID0gXCJpZFwiXHJcbn1cclxuXHJcbmNsYXNzIENhdGVnb3J5UGFja2FnZUFkYXB0ZXIgaW1wbGVtZW50cyBJUGFja2FnZUFkYXB0ZXIge1xyXG5cclxuICAgIC8vbmV3ZXN0IHZlcnNpb24gb2YgcGFja2FnZSBmb3JtYXRcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgY3VycmVudFBhY2thZ2VWZXJzaW9uOiBudW1iZXIgPSAxO1xyXG5cclxuICAgIHByaXZhdGUgc2V0dGluZ3NUeXBlOiBzdHJpbmc7XHJcbiAgICBwcml2YXRlIG9iamVjdFR5cGU6IE9iamVjdFR5cGU7XHJcblxyXG4gICAgY29uc3RydWN0b3IoKSB7XHJcbiAgICAgICAgdGhpcy5zZXR0aW5nc1R5cGUgPSBcImNhdGVnb3J5XCI7XHJcbiAgICAgICAgdGhpcy5vYmplY3RUeXBlID0gT2JqZWN0VHlwZS5DQVRFR09SWTtcclxuICAgIH1cclxuICAgIHBhY2thZ2VUb1NldHRpbmcocGFja2FnZURhdGE6IElQYWNrYWdlLCBjb250YWluZXI6IEV4cG9ydENvbnRhaW5lcik6IElTZXR0aW5ncyB7XHJcbiAgICAgICAgXHJcbiAgICAgICAgbGV0IHNldHRpbmc6IElTZXR0aW5ncyA9IG5ldyBTZXR0aW5ncyh0aGlzLnNldHRpbmdzVHlwZSk7XHJcblxyXG4gICAgICAgIGlmKHBhY2thZ2VEYXRhPy5tZXRhPy5kYXRhVHlwZSA9PT0gRGF0YVR5cGUuT0JKRUNUICYmIHBhY2thZ2VEYXRhPy5tZXRhPy5bQWRkaXRpb25hbE1ldGFLZXlzLk9CSkVDVFRZUEVdID09PSB0aGlzLm9iamVjdFR5cGUpIHtcclxuICAgICAgICAgICBcclxuICAgICAgICAgICAgc3dpdGNoKHBhY2thZ2VEYXRhPy5tZXRhPy5bQWRkaXRpb25hbE1ldGFLZXlzLlZFUlNJT05dKXsgXHJcbiAgICAgICAgICAgICAgICBjYXNlIDE6XHJcbiAgICAgICAgICAgICAgICAgICAgc2V0dGluZyA9IHRoaXMucGFja2FnZVYxVG9TZXR0aW5nKHBhY2thZ2VEYXRhLCBjb250YWluZXIpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgdGhyb3cgTWNlQ29udmVyc2lvbkVycm9yLmNyZWF0ZUVycm9yQnlUeXBlKE1jZUNvbnZlcnNpb25FcnJvclR5cGUuVU5TVVBQT1JURURfVkVSU0lPTiwgdGhpcy5vYmplY3RUeXBlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRocm93IE1jZUNvbnZlcnNpb25FcnJvci5jcmVhdGVFcnJvckJ5VHlwZShNY2VDb252ZXJzaW9uRXJyb3JUeXBlLlVOU1VQUE9SVEVEX1RZUEUsIHRoaXMub2JqZWN0VHlwZSk7XHJcbiAgICAgICAgfSBcclxuXHJcbiAgICAgICAgcmV0dXJuIHNldHRpbmc7XHJcbiAgICB9ICAgIFxyXG5cclxuICAgIHByaXZhdGUgcGFja2FnZVYxVG9TZXR0aW5nKHBhY2thZ2VEYXRhOiBJUGFja2FnZSwgY29udGFpbmVyOiBFeHBvcnRDb250YWluZXIpOiBJU2V0dGluZ3Mge1xyXG5cclxuICAgICAgICBsZXQgc2V0dGluZyA9IG5ldyBTZXR0aW5ncyh0aGlzLnNldHRpbmdzVHlwZSk7XHJcblxyXG4gICAgICAgIGlmKHBhY2thZ2VEYXRhPy5kYXRhPy5bRGF0YUlkcy5DYXRlZ29yeUlkXT8ubWV0YT8uZGF0YVR5cGUgPT09IERhdGFUeXBlLlNUUklORykge1xyXG4gICAgICAgICAgICBzZXR0aW5nLnNldFZhbHVlKFNldHRpbmdJZHMuQ2F0ZWdvcnlJZCwgcGFja2FnZURhdGE/LmRhdGE/LltEYXRhSWRzLkNhdGVnb3J5SWRdPy5kYXRhKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aHJvdyBNY2VDb252ZXJzaW9uRXJyb3IuY3JlYXRlRXJyb3JCeVR5cGUoTWNlQ29udmVyc2lvbkVycm9yVHlwZS5NSVNTSU5HX0RBVEEsIERhdGFJZHMuQ2F0ZWdvcnlJZCk7O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYocGFja2FnZURhdGE/LmRhdGE/LltEYXRhSWRzLlNlcmllR3JvdXBzXT8ubWV0YT8uZGF0YVR5cGUgPT09IERhdGFUeXBlLkFSUkFZICYmIHBhY2thZ2VEYXRhPy5kYXRhPy5bRGF0YUlkcy5TZXJpZUdyb3Vwc10/Lm1ldGE/LltBZGRpdGlvbmFsTWV0YUtleXMuQVJSQVlUWVBFXSA9PT0gQXJyYXlUeXBlLkxJTksgKSB7XHJcbiAgICAgICAgICAgIGxldCBzZXJpZUdyb3VwU2V0dGluZ3MgPSBuZXcgQXJyYXk8SVNldHRpbmdzPigpO1xyXG4gICAgICAgICAgICBsZXQgbGlua0FycmF5OiBBcnJheTxudW1iZXI+IHwgdW5kZWZpbmVkID0gcGFja2FnZURhdGE/LmRhdGE/LltEYXRhSWRzLlNlcmllR3JvdXBzXT8uZGF0YTtcclxuICAgICAgICAgICAgaWYobGlua0FycmF5ICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIGxpbmtBcnJheS5mb3JFYWNoKChpZCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBzZXJpZUdyb3VwU2V0dGluZyA9IGNvbnRhaW5lci5nZXRTZXR0aW5nc0J5SUQoaWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKHNlcmllR3JvdXBTZXR0aW5nICE9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlcmllR3JvdXBTZXR0aW5ncy5wdXNoKHNlcmllR3JvdXBTZXR0aW5nKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBNY2VDb252ZXJzaW9uRXJyb3IuY3JlYXRlRXJyb3JCeVR5cGUoTWNlQ29udmVyc2lvbkVycm9yVHlwZS5NSVNTSU5HX0RBVEEsIERhdGFJZHMuU2VyaWVHcm91cHMpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgTWNlQ29udmVyc2lvbkVycm9yLmNyZWF0ZUVycm9yQnlUeXBlKE1jZUNvbnZlcnNpb25FcnJvclR5cGUuTUlTU0lOR19EQVRBLCBEYXRhSWRzLlNlcmllR3JvdXBzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBzZXR0aW5nLnNldFZhbHVlKFNldHRpbmdJZHMuU2VyaWVHcm91cHMsIHNlcmllR3JvdXBTZXR0aW5ncyk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhyb3cgTWNlQ29udmVyc2lvbkVycm9yLmNyZWF0ZUVycm9yQnlUeXBlKE1jZUNvbnZlcnNpb25FcnJvclR5cGUuTUlTU0lOR19EQVRBLCBEYXRhSWRzLlNlcmllR3JvdXBzKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBzZXR0aW5nO1xyXG4gICAgfVxyXG5cclxuICAgIHNldHRpbmdUb1BhY2thZ2Uoc2V0dGluZ3NEYXRhOiBJU2V0dGluZ3MpOiBQYWNrYWdlQXJyYXlXaXRoVG9wTGV2ZWxJRCB7XHJcbiAgICAgICAgXHJcbiAgICAgICAgbGV0IHNldHRpbmdzID0gU2V0dGluZ3MuY3JlYXRlKHNldHRpbmdzRGF0YSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgbGV0IGNhdGVnb3J5RGF0YTogeyBbaW5kZXg6IHN0cmluZ106ICBJUGFja2FnZSB9ICA9IHt9O1xyXG5cclxuICAgICAgICBsZXQgcGFja2FnZVN0cnVjdHVyZTogUGFja2FnZUFycmF5V2l0aFRvcExldmVsSUQgPSB7XHJcbiAgICAgICAgICAgIHBhY2thZ2VzOiBuZXcgQXJyYXk8SVBhY2thZ2U+KCksXHJcbiAgICAgICAgICAgIHRvcExldmVsSUQ6IE5hTlxyXG4gICAgICAgIH07XHJcbiAgICAgICAgaWYoc2V0dGluZ3MudHlwZSA9PT0gdGhpcy5zZXR0aW5nc1R5cGUpIHtcclxuXHJcbiAgICAgICAgICAgIGxldCBpZCA9IE1ldGEuY3JlYXRlSUQoKTtcclxuICAgICAgICAgICAgbGV0IGFkZGl0aW9uYWxNZXRhS2V5cyA9IFt7a2V5OiBBZGRpdGlvbmFsTWV0YUtleXMuT0JKRUNUVFlQRSwgdmFsdWU6IHRoaXMub2JqZWN0VHlwZX0sIHtrZXk6IEFkZGl0aW9uYWxNZXRhS2V5cy5JRCwgdmFsdWU6IGlkfSwge2tleTogQWRkaXRpb25hbE1ldGFLZXlzLlZFUlNJT04sIHZhbHVlOiB0aGlzLmN1cnJlbnRQYWNrYWdlVmVyc2lvbn1dXHJcbiAgICAgICAgICAgIGxldCBjYXRlZ29yeU1ldGEgPSBuZXcgTWV0YShEYXRhVHlwZS5PQkpFQ1QsIGFkZGl0aW9uYWxNZXRhS2V5cyk7XHJcbiAgICAgICAgICAgIGxldCBzZXJpZUdyb3Vwc01ldGEgPSBuZXcgTWV0YShEYXRhVHlwZS5BUlJBWSwgW3trZXk6IEFkZGl0aW9uYWxNZXRhS2V5cy5BUlJBWVRZUEUsIHZhbHVlOiBBcnJheVR5cGUuTElOS31dKTtcclxuICAgICAgICAgICAgbGV0IHNlcmllR3JvdXBzTGlua3MgPSBuZXcgQXJyYXk8bnVtYmVyPigpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgbGV0IHNlcmllR3JvdXBzRGF0YTogQXJyYXk8SVNldHRpbmdzPiA9IHNldHRpbmdzLmdldFZhbHVlKFNldHRpbmdJZHMuU2VyaWVHcm91cHMpO1xyXG4gICAgICAgICAgICBpZihzZXJpZUdyb3Vwc0RhdGEgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgc2VyaWVHcm91cHNEYXRhLmZvckVhY2goKHNlcmllR3JvdXBTZXR0aW5nKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IHNlcmllR3JvdXBQYWNrYWdlU3RydWN0dXJlID0gRXhwb3J0Q29udGFpbmVyLmNyZWF0ZVBhY2thZ2VzKHNlcmllR3JvdXBTZXR0aW5nKTtcclxuICAgICAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgICAgICBpZihzZXJpZUdyb3VwUGFja2FnZVN0cnVjdHVyZS5wYWNrYWdlcy5sZW5ndGggPiAwICYmICFOdW1iZXIuaXNOYU4oc2VyaWVHcm91cFBhY2thZ2VTdHJ1Y3R1cmUudG9wTGV2ZWxJRCkpIHsgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlcmllR3JvdXBzTGlua3MucHVzaChzZXJpZUdyb3VwUGFja2FnZVN0cnVjdHVyZS50b3BMZXZlbElEKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcGFja2FnZVN0cnVjdHVyZS5wYWNrYWdlcy5wdXNoKC4uLnNlcmllR3JvdXBQYWNrYWdlU3RydWN0dXJlLnBhY2thZ2VzKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIGNhdGVnb3J5RGF0YVtEYXRhSWRzLlNlcmllR3JvdXBzXSA9IG5ldyBQYWNrYWdlKHNlcmllR3JvdXBzTWV0YSwgc2VyaWVHcm91cHNMaW5rcyk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBNY2VDb252ZXJzaW9uRXJyb3IuY3JlYXRlRXJyb3JCeVR5cGUoTWNlQ29udmVyc2lvbkVycm9yVHlwZS5NSVNTSU5HX0RBVEEsIFNldHRpbmdJZHMuU2VyaWVHcm91cHMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgbGV0IGNhdGVnb3J5SWREYXRhID0gc2V0dGluZ3MuZ2V0VmFsdWUoU2V0dGluZ0lkcy5DYXRlZ29yeUlkKTtcclxuICAgICAgICAgICAgaWYoY2F0ZWdvcnlJZERhdGEgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgY2F0ZWdvcnlEYXRhW0RhdGFJZHMuQ2F0ZWdvcnlJZF0gPSBuZXcgUGFja2FnZShuZXcgTWV0YShEYXRhVHlwZS5TVFJJTkcpLCBjYXRlZ29yeUlkRGF0YSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBNY2VDb252ZXJzaW9uRXJyb3IuY3JlYXRlRXJyb3JCeVR5cGUoTWNlQ29udmVyc2lvbkVycm9yVHlwZS5NSVNTSU5HX0RBVEEsIFNldHRpbmdJZHMuQ2F0ZWdvcnlJZCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgXHJcblxyXG4gICAgICAgICAgICBsZXQgY2F0ZWdvcnlQYWNrYWdlID0gbmV3IFBhY2thZ2UoY2F0ZWdvcnlNZXRhLCBjYXRlZ29yeURhdGEpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgcGFja2FnZVN0cnVjdHVyZS5wYWNrYWdlcy5wdXNoKGNhdGVnb3J5UGFja2FnZSk7XHJcbiAgICAgICAgICAgIHBhY2thZ2VTdHJ1Y3R1cmUudG9wTGV2ZWxJRCA9IGlkO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRocm93IE1jZUNvbnZlcnNpb25FcnJvci5jcmVhdGVFcnJvckJ5VHlwZShNY2VDb252ZXJzaW9uRXJyb3JUeXBlLlVOU1VQUE9SVEVEX1ZFUlNJT04sIHRoaXMuc2V0dGluZ3NUeXBlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgIHJldHVybiBwYWNrYWdlU3RydWN0dXJlOyAgICAgICAgXHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCB7IENhdGVnb3J5UGFja2FnZUFkYXB0ZXIgfSJdfQ==