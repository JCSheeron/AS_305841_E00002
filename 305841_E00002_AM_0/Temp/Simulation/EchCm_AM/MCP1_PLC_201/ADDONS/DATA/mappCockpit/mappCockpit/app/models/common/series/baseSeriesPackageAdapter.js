define(["require", "exports", "../../../common/packageConversion/enum/objectTypeEnum", "../../../common/packageConversion/exportContainer", "../../../common/persistence/settings", "../../../common/packageConversion/enum/dataTypeEnum", "../../../common/packageConversion/enum/additionalMetaKeys", "../../../common/packageConversion/mceConversionError", "./settingIds", "../../../common/packageConversion/package", "../../../common/packageConversion/meta"], function (require, exports, objectTypeEnum_1, exportContainer_1, settings_1, dataTypeEnum_1, additionalMetaKeys_1, mceConversionError_1, settingIds_1, package_1, meta_1) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    var DataIds;
    (function (DataIds) {
        DataIds["SeriesId"] = "id";
        DataIds["SeriesName"] = "name";
        DataIds["SeriesColor"] = "color";
        DataIds["SeriesSignalData"] = "signalData";
        DataIds["SeriesCalculationData"] = "calculationData";
    })(DataIds || (DataIds = {}));
    var BaseSeriesPackageAdapter = /** @class */ (function () {
        function BaseSeriesPackageAdapter() {
            //newest version of package format
            this.currentPackageVersion = 1;
            this.settingsType = "BaseSeries";
            this.objectType = objectTypeEnum_1.ObjectType.BASESERIES;
        }
        BaseSeriesPackageAdapter.prototype.packageToSetting = function (packageData, container) {
            var _a, _b, _c;
            var setting = new settings_1.Settings(this.settingsType);
            if (((_a = packageData === null || packageData === void 0 ? void 0 : packageData.meta) === null || _a === void 0 ? void 0 : _a.dataType) == dataTypeEnum_1.DataType.OBJECT && ((_b = packageData === null || packageData === void 0 ? void 0 : packageData.meta) === null || _b === void 0 ? void 0 : _b[additionalMetaKeys_1.AdditionalMetaKeys.OBJECTTYPE]) == this.objectType) {
                switch ((_c = packageData === null || packageData === void 0 ? void 0 : packageData.meta) === null || _c === void 0 ? void 0 : _c[additionalMetaKeys_1.AdditionalMetaKeys.VERSION]) {
                    case 1:
                        setting = this.packageV1ToSetting(packageData, container);
                        break;
                    default:
                        throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.UNSUPPORTED_VERSION, this.objectType);
                }
            }
            else {
                throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.UNSUPPORTED_TYPE, this.objectType);
            }
            return setting;
        };
        BaseSeriesPackageAdapter.prototype.packageV1ToSetting = function (packageData, container) {
            var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k, _l, _m, _o, _p, _q, _r, _s, _t, _u, _v, _w, _x, _y, _z;
            var setting = new settings_1.Settings(this.settingsType);
            if (((_c = (_b = (_a = packageData === null || packageData === void 0 ? void 0 : packageData.data) === null || _a === void 0 ? void 0 : _a[DataIds.SeriesId]) === null || _b === void 0 ? void 0 : _b.meta) === null || _c === void 0 ? void 0 : _c.dataType) == dataTypeEnum_1.DataType.STRING) {
                setting.setValue(settingIds_1.SettingIds.SeriesId, (_e = (_d = packageData === null || packageData === void 0 ? void 0 : packageData.data) === null || _d === void 0 ? void 0 : _d[DataIds.SeriesId]) === null || _e === void 0 ? void 0 : _e.data);
            }
            else {
                throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.MISSING_DATA, DataIds.SeriesId);
            }
            if (((_h = (_g = (_f = packageData === null || packageData === void 0 ? void 0 : packageData.data) === null || _f === void 0 ? void 0 : _f[DataIds.SeriesName]) === null || _g === void 0 ? void 0 : _g.meta) === null || _h === void 0 ? void 0 : _h.dataType) == dataTypeEnum_1.DataType.STRING) {
                setting.setValue(settingIds_1.SettingIds.SeriesName, (_k = (_j = packageData === null || packageData === void 0 ? void 0 : packageData.data) === null || _j === void 0 ? void 0 : _j[DataIds.SeriesName]) === null || _k === void 0 ? void 0 : _k.data);
            }
            else {
                throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.MISSING_DATA, DataIds.SeriesName);
            }
            if (((_o = (_m = (_l = packageData === null || packageData === void 0 ? void 0 : packageData.data) === null || _l === void 0 ? void 0 : _l[DataIds.SeriesColor]) === null || _m === void 0 ? void 0 : _m.meta) === null || _o === void 0 ? void 0 : _o.dataType) == dataTypeEnum_1.DataType.STRING) {
                setting.setValue(settingIds_1.SettingIds.SeriesColor, (_q = (_p = packageData === null || packageData === void 0 ? void 0 : packageData.data) === null || _p === void 0 ? void 0 : _p[DataIds.SeriesColor]) === null || _q === void 0 ? void 0 : _q.data);
            }
            else {
                throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.MISSING_DATA, DataIds.SeriesColor);
            }
            if (((_s = (_r = packageData === null || packageData === void 0 ? void 0 : packageData.data) === null || _r === void 0 ? void 0 : _r[DataIds.SeriesSignalData]) === null || _s === void 0 ? void 0 : _s.meta.dataType) == dataTypeEnum_1.DataType.LINK) {
                var id = (_u = (_t = packageData === null || packageData === void 0 ? void 0 : packageData.data) === null || _t === void 0 ? void 0 : _t[DataIds.SeriesSignalData]) === null || _u === void 0 ? void 0 : _u.data;
                var signalDataSetting = container.getSettingsByID(id);
                if (signalDataSetting !== null) {
                    setting.setValue(settingIds_1.SettingIds.SeriesSignalData, signalDataSetting);
                }
            }
            else if (((_x = (_w = (_v = packageData === null || packageData === void 0 ? void 0 : packageData.data) === null || _v === void 0 ? void 0 : _v[DataIds.SeriesCalculationData]) === null || _w === void 0 ? void 0 : _w.meta) === null || _x === void 0 ? void 0 : _x.dataType) == dataTypeEnum_1.DataType.LINK) {
                var id = (_z = (_y = packageData === null || packageData === void 0 ? void 0 : packageData.data) === null || _y === void 0 ? void 0 : _y[DataIds.SeriesCalculationData]) === null || _z === void 0 ? void 0 : _z.data;
                var calculationDataInfoSetting = container.getSettingsByID(id);
                if (calculationDataInfoSetting !== undefined) {
                    setting.setValue(settingIds_1.SettingIds.SeriesCalculationData, calculationDataInfoSetting);
                }
            }
            else {
                throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.MISSING_DATA, DataIds.SeriesSignalData + "/" + DataIds.SeriesCalculationData);
            }
            return setting;
        };
        BaseSeriesPackageAdapter.prototype.settingToPackage = function (settingsData) {
            var _a, _b;
            var settings = settings_1.Settings.create(settingsData);
            var seriesData = {};
            var packageStructure = {
                packages: new Array(),
                topLevelID: NaN
            };
            if (settings.type === this.settingsType) {
                var id = meta_1.Meta.createID();
                var additionalMetaInfo = [{ key: additionalMetaKeys_1.AdditionalMetaKeys.OBJECTTYPE, value: this.objectType }, { key: additionalMetaKeys_1.AdditionalMetaKeys.ID, value: id }, { key: additionalMetaKeys_1.AdditionalMetaKeys.VERSION, value: this.currentPackageVersion }];
                var seriesMeta = new meta_1.Meta(dataTypeEnum_1.DataType.OBJECT, additionalMetaInfo);
                var seriesIdData = settings.getValue(settingIds_1.SettingIds.SeriesId);
                if (seriesIdData !== undefined) {
                    seriesData[DataIds.SeriesId] = new package_1.Package(new meta_1.Meta(dataTypeEnum_1.DataType.STRING), seriesIdData);
                }
                else {
                    throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.MISSING_DATA, settingIds_1.SettingIds.SeriesId);
                }
                var seriesNameData = settings.getValue(settingIds_1.SettingIds.SeriesName);
                if (seriesNameData !== undefined) {
                    seriesData[DataIds.SeriesName] = new package_1.Package(new meta_1.Meta(dataTypeEnum_1.DataType.STRING), seriesNameData);
                }
                else {
                    throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.MISSING_DATA, settingIds_1.SettingIds.SeriesName);
                }
                var seriesColorData = settings.getValue(settingIds_1.SettingIds.SeriesColor);
                if (seriesColorData !== undefined) {
                    seriesData[DataIds.SeriesColor] = new package_1.Package(new meta_1.Meta(dataTypeEnum_1.DataType.STRING), seriesColorData);
                }
                else {
                    throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.MISSING_DATA, settingIds_1.SettingIds.SeriesColor);
                }
                var seriesSignalDataData = settings.getValue(settingIds_1.SettingIds.SeriesSignalData);
                var seriesCalculationDataInfoData = settings.getValue(settingIds_1.SettingIds.SeriesCalculationData);
                if (seriesSignalDataData !== undefined) {
                    var signalDataPackageStructure = exportContainer_1.ExportContainer.createPackages(seriesSignalDataData);
                    if (signalDataPackageStructure.packages.length > 0 && !Number.isNaN(signalDataPackageStructure.topLevelID)) {
                        seriesData[DataIds.SeriesSignalData] = new package_1.Package(new meta_1.Meta(dataTypeEnum_1.DataType.LINK), signalDataPackageStructure.topLevelID);
                        (_a = packageStructure.packages).push.apply(_a, signalDataPackageStructure.packages);
                    }
                    else {
                        throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.MISSING_DATA, settingIds_1.SettingIds.SeriesSignalData + "/" + seriesCalculationDataInfoData);
                    }
                }
                else if (seriesCalculationDataInfoData !== undefined) {
                    var calculationDataInfoPackageStructure = exportContainer_1.ExportContainer.createPackages(seriesCalculationDataInfoData);
                    if (calculationDataInfoPackageStructure.packages.length > 0 && !Number.isNaN(calculationDataInfoPackageStructure.topLevelID)) {
                        seriesData[DataIds.SeriesCalculationData] = new package_1.Package(new meta_1.Meta(dataTypeEnum_1.DataType.LINK), calculationDataInfoPackageStructure.topLevelID);
                        (_b = packageStructure.packages).push.apply(_b, calculationDataInfoPackageStructure.packages);
                    }
                    else {
                        throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.MISSING_DATA, settingIds_1.SettingIds.SeriesSignalData + "/" + seriesCalculationDataInfoData);
                    }
                }
                else {
                    throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.MISSING_DATA, settingIds_1.SettingIds.SeriesSignalData + "/" + seriesCalculationDataInfoData);
                }
                var seriesPackage = new package_1.Package(seriesMeta, seriesData);
                packageStructure.packages.push(seriesPackage);
                packageStructure.topLevelID = id;
            }
            else {
                throw mceConversionError_1.MceConversionError.createErrorByType(mceConversionError_1.MceConversionErrorType.UNSUPPORTED_VERSION, this.settingsType);
            }
            return packageStructure;
        };
        return BaseSeriesPackageAdapter;
    }());
    exports.BaseSeriesPackageAdapter = BaseSeriesPackageAdapter;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZVNlcmllc1BhY2thZ2VBZGFwdGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2FwcC9tb2RlbHMvY29tbW9uL3Nlcmllcy9iYXNlU2VyaWVzUGFja2FnZUFkYXB0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0lBY0EsSUFBSyxPQU1KO0lBTkQsV0FBSyxPQUFPO1FBQ1IsMEJBQWUsQ0FBQTtRQUNmLDhCQUFtQixDQUFBO1FBQ25CLGdDQUFxQixDQUFBO1FBQ3JCLDBDQUErQixDQUFBO1FBQy9CLG9EQUF5QyxDQUFBO0lBQzdDLENBQUMsRUFOSSxPQUFPLEtBQVAsT0FBTyxRQU1YO0lBRUQ7UUFRSTtZQU5BLGtDQUFrQztZQUNqQiwwQkFBcUIsR0FBRyxDQUFDLENBQUM7WUFNdkMsSUFBSSxDQUFDLFlBQVksR0FBRyxZQUFZLENBQUM7WUFDakMsSUFBSSxDQUFDLFVBQVUsR0FBRywyQkFBVSxDQUFDLFVBQVUsQ0FBQztRQUM1QyxDQUFDO1FBQ0QsbURBQWdCLEdBQWhCLFVBQWlCLFdBQXFCLEVBQUUsU0FBMEI7O1lBRTlELElBQUksT0FBTyxHQUFjLElBQUksbUJBQVEsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7WUFFekQsSUFBRyxPQUFBLFdBQVcsYUFBWCxXQUFXLHVCQUFYLFdBQVcsQ0FBRSxJQUFJLDBDQUFFLFFBQVEsS0FBSSx1QkFBUSxDQUFDLE1BQU0sSUFBSSxPQUFBLFdBQVcsYUFBWCxXQUFXLHVCQUFYLFdBQVcsQ0FBRSxJQUFJLDBDQUFHLHVDQUFrQixDQUFDLFVBQVUsTUFBSyxJQUFJLENBQUMsVUFBVSxFQUFFO2dCQUV4SCxjQUFPLFdBQVcsYUFBWCxXQUFXLHVCQUFYLFdBQVcsQ0FBRSxJQUFJLDBDQUFHLHVDQUFrQixDQUFDLE9BQU8sR0FBRTtvQkFDbkQsS0FBSyxDQUFDO3dCQUNGLE9BQU8sR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsV0FBVyxFQUFF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QixDQUFDLGlCQUFpQixDQUFDLDJDQUFzQixDQUFDLG1CQUFtQixFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQzthQUM3RztZQUVELE9BQU8sZ0JBQWdCLENBQUM7UUFDNUIsQ0FBQztRQUNMLCtCQUFDO0lBQUQsQ0FBQyxBQWpKRCxJQWlKQztJQUVRLDREQUF3QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IElQYWNrYWdlQWRhcHRlciwgUGFja2FnZUFycmF5V2l0aFRvcExldmVsSUQgfSBmcm9tIFwiLi4vLi4vLi4vY29tbW9uL3BhY2thZ2VDb252ZXJzaW9uL2ludGVyZmFjZS9wYWNrYWdlQWRhcHRlckludGVyZmFjZVwiO1xyXG5pbXBvcnQgeyBPYmplY3RUeXBlIH0gZnJvbSBcIi4uLy4uLy4uL2NvbW1vbi9wYWNrYWdlQ29udmVyc2lvbi9lbnVtL29iamVjdFR5cGVFbnVtXCI7XHJcbmltcG9ydCB7IElQYWNrYWdlIH0gZnJvbSBcIi4uLy4uLy4uL2NvbW1vbi9wYWNrYWdlQ29udmVyc2lvbi9pbnRlcmZhY2UvcGFja2FnZUludGVyZmFjZVwiO1xyXG5pbXBvcnQgeyBFeHBvcnRDb250YWluZXIgfSBmcm9tIFwiLi4vLi4vLi4vY29tbW9uL3BhY2thZ2VDb252ZXJzaW9uL2V4cG9ydENvbnRhaW5lclwiO1xyXG5pbXBvcnQgeyBJU2V0dGluZ3MgfSBmcm9tIFwiLi4vLi4vLi4vY29tbW9uL3BlcnNpc3RlbmNlL2ludGVyZmFjZXMvc2V0dGluZ3NJbnRlcmZhY2VcIjtcclxuaW1wb3J0IHsgU2V0dGluZ3MgfSBmcm9tIFwiLi4vLi4vLi4vY29tbW9uL3BlcnNpc3RlbmNlL3NldHRpbmdzXCI7XHJcbmltcG9ydCB7IERhdGFUeXBlIH0gZnJvbSBcIi4uLy4uLy4uL2NvbW1vbi9wYWNrYWdlQ29udmVyc2lvbi9lbnVtL2RhdGFUeXBlRW51bVwiO1xyXG5pbXBvcnQgeyBBZGRpdGlvbmFsTWV0YUtleXMgfSBmcm9tIFwiLi4vLi4vLi4vY29tbW9uL3BhY2thZ2VDb252ZXJzaW9uL2VudW0vYWRkaXRpb25hbE1ldGFLZXlzXCI7XHJcbmltcG9ydCB7IE1jZUNvbnZlcnNpb25FcnJvciwgTWNlQ29udmVyc2lvbkVycm9yVHlwZSB9IGZyb20gXCIuLi8uLi8uLi9jb21tb24vcGFja2FnZUNvbnZlcnNpb24vbWNlQ29udmVyc2lvbkVycm9yXCI7XHJcbmltcG9ydCB7IFNldHRpbmdJZHMgfSBmcm9tIFwiLi9zZXR0aW5nSWRzXCI7XHJcbmltcG9ydCB7IFBhY2thZ2UgfSBmcm9tIFwiLi4vLi4vLi4vY29tbW9uL3BhY2thZ2VDb252ZXJzaW9uL3BhY2thZ2VcIjtcclxuaW1wb3J0IHsgTWV0YSB9IGZyb20gXCIuLi8uLi8uLi9jb21tb24vcGFja2FnZUNvbnZlcnNpb24vbWV0YVwiO1xyXG5cclxuXHJcbmVudW0gRGF0YUlkcyB7XHJcbiAgICBTZXJpZXNJZCA9IFwiaWRcIixcclxuICAgIFNlcmllc05hbWUgPSBcIm5hbWVcIixcclxuICAgIFNlcmllc0NvbG9yID0gXCJjb2xvclwiLFxyXG4gICAgU2VyaWVzU2lnbmFsRGF0YSA9IFwic2lnbmFsRGF0YVwiLFxyXG4gICAgU2VyaWVzQ2FsY3VsYXRpb25EYXRhID0gXCJjYWxjdWxhdGlvbkRhdGFcIlxyXG59XHJcblxyXG5jbGFzcyBCYXNlU2VyaWVzUGFja2FnZUFkYXB0ZXIgaW1wbGVtZW50cyBJUGFja2FnZUFkYXB0ZXIge1xyXG4gICBcclxuICAgIC8vbmV3ZXN0IHZlcnNpb24gb2YgcGFja2FnZSBmb3JtYXRcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgY3VycmVudFBhY2thZ2VWZXJzaW9uID0gMTtcclxuXHJcbiAgICBwcm90ZWN0ZWQgc2V0dGluZ3NUeXBlOiBzdHJpbmc7XHJcbiAgICBwcm90ZWN0ZWQgb2JqZWN0VHlwZTogT2JqZWN0VHlwZTtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcigpIHtcclxuICAgICAgICB0aGlzLnNldHRpbmdzVHlwZSA9IFwiQmFzZVNlcmllc1wiO1xyXG4gICAgICAgIHRoaXMub2JqZWN0VHlwZSA9IE9iamVjdFR5cGUuQkFTRVNFUklFUztcclxuICAgIH1cclxuICAgIHBhY2thZ2VUb1NldHRpbmcocGFja2FnZURhdGE6IElQYWNrYWdlLCBjb250YWluZXI6IEV4cG9ydENvbnRhaW5lcik6IElTZXR0aW5ncyB7XHJcblxyXG4gICAgICAgIGxldCBzZXR0aW5nOiBJU2V0dGluZ3MgPSBuZXcgU2V0dGluZ3ModGhpcy5zZXR0aW5nc1R5cGUpO1xyXG5cclxuICAgICAgICBpZihwYWNrYWdlRGF0YT8ubWV0YT8uZGF0YVR5cGUgPT0gRGF0YVR5cGUuT0JKRUNUICYmIHBhY2thZ2VEYXRhPy5tZXRhPy5bQWRkaXRpb25hbE1ldGFLZXlzLk9CSkVDVFRZUEVdID09IHRoaXMub2JqZWN0VHlwZSkge1xyXG4gICAgICAgICAgIFxyXG4gICAgICAgICAgICBzd2l0Y2gocGFja2FnZURhdGE/Lm1ldGE/LltBZGRpdGlvbmFsTWV0YUtleXMuVkVSU0lPTl0peyBcclxuICAgICAgICAgICAgICAgIGNhc2UgMTpcclxuICAgICAgICAgICAgICAgICAgICBzZXR0aW5nID0gdGhpcy5wYWNrYWdlVjFUb1NldHRpbmcocGFja2FnZURhdGEsIGNvbnRhaW5lcik7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgICAgIHRocm93IE1jZUNvbnZlcnNpb25FcnJvci5jcmVhdGVFcnJvckJ5VHlwZShNY2VDb252ZXJzaW9uRXJyb3JUeXBlLlVOU1VQUE9SVEVEX1ZFUlNJT04sIHRoaXMub2JqZWN0VHlwZSlcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRocm93IE1jZUNvbnZlcnNpb25FcnJvci5jcmVhdGVFcnJvckJ5VHlwZShNY2VDb252ZXJzaW9uRXJyb3JUeXBlLlVOU1VQUE9SVEVEX1RZUEUsIHRoaXMub2JqZWN0VHlwZSlcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBzZXR0aW5nO1xyXG4gICAgXHJcbiAgICB9ICAgIFxyXG5cclxuICAgIHByaXZhdGUgcGFja2FnZVYxVG9TZXR0aW5nKHBhY2thZ2VEYXRhOiBJUGFja2FnZSwgY29udGFpbmVyOiBFeHBvcnRDb250YWluZXIpOiBJU2V0dGluZ3Mge1xyXG4gICAgICAgIGxldCBzZXR0aW5nID0gbmV3IFNldHRpbmdzKHRoaXMuc2V0dGluZ3NUeXBlKTtcclxuXHJcbiAgICAgICAgaWYocGFja2FnZURhdGE/LmRhdGE/LltEYXRhSWRzLlNlcmllc0lkXT8ubWV0YT8uZGF0YVR5cGUgPT0gRGF0YVR5cGUuU1RSSU5HKSB7XHJcbiAgICAgICAgICAgIHNldHRpbmcuc2V0VmFsdWUoU2V0dGluZ0lkcy5TZXJpZXNJZCwgcGFja2FnZURhdGE/LmRhdGE/LltEYXRhSWRzLlNlcmllc0lkXT8uZGF0YSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhyb3cgTWNlQ29udmVyc2lvbkVycm9yLmNyZWF0ZUVycm9yQnlUeXBlKE1jZUNvbnZlcnNpb25FcnJvclR5cGUuTUlTU0lOR19EQVRBLCBEYXRhSWRzLlNlcmllc0lkKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYocGFja2FnZURhdGE/LmRhdGE/LltEYXRhSWRzLlNlcmllc05hbWVdPy5tZXRhPy5kYXRhVHlwZSA9PSBEYXRhVHlwZS5TVFJJTkcpIHtcclxuICAgICAgICAgICAgc2V0dGluZy5zZXRWYWx1ZShTZXR0aW5nSWRzLlNlcmllc05hbWUsIHBhY2thZ2VEYXRhPy5kYXRhPy5bRGF0YUlkcy5TZXJpZXNOYW1lXT8uZGF0YSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhyb3cgTWNlQ29udmVyc2lvbkVycm9yLmNyZWF0ZUVycm9yQnlUeXBlKE1jZUNvbnZlcnNpb25FcnJvclR5cGUuTUlTU0lOR19EQVRBLCBEYXRhSWRzLlNlcmllc05hbWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZihwYWNrYWdlRGF0YT8uZGF0YT8uW0RhdGFJZHMuU2VyaWVzQ29sb3JdPy5tZXRhPy5kYXRhVHlwZSA9PSBEYXRhVHlwZS5TVFJJTkcpIHtcclxuICAgICAgICAgICAgc2V0dGluZy5zZXRWYWx1ZShTZXR0aW5nSWRzLlNlcmllc0NvbG9yLCBwYWNrYWdlRGF0YT8uZGF0YT8uW0RhdGFJZHMuU2VyaWVzQ29sb3JdPy5kYXRhKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aHJvdyBNY2VDb252ZXJzaW9uRXJyb3IuY3JlYXRlRXJyb3JCeVR5cGUoTWNlQ29udmVyc2lvbkVycm9yVHlwZS5NSVNTSU5HX0RBVEEsIERhdGFJZHMuU2VyaWVzQ29sb3IpXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmKHBhY2thZ2VEYXRhPy5kYXRhPy5bRGF0YUlkcy5TZXJpZXNTaWduYWxEYXRhXT8ubWV0YS5kYXRhVHlwZSA9PSBEYXRhVHlwZS5MSU5LKSB7XHJcbiAgICAgICAgICAgIGxldCBpZCA9IHBhY2thZ2VEYXRhPy5kYXRhPy5bRGF0YUlkcy5TZXJpZXNTaWduYWxEYXRhXT8uZGF0YTtcclxuICAgICAgICAgICAgbGV0IHNpZ25hbERhdGFTZXR0aW5nID0gY29udGFpbmVyLmdldFNldHRpbmdzQnlJRChpZCk7XHJcbiAgICAgICAgICAgIGlmKHNpZ25hbERhdGFTZXR0aW5nICE9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICBzZXR0aW5nLnNldFZhbHVlKFNldHRpbmdJZHMuU2VyaWVzU2lnbmFsRGF0YSwgc2lnbmFsRGF0YVNldHRpbmcpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIGlmKHBhY2thZ2VEYXRhPy5kYXRhPy5bRGF0YUlkcy5TZXJpZXNDYWxjdWxhdGlvbkRhdGFdPy5tZXRhPy5kYXRhVHlwZSA9PSBEYXRhVHlwZS5MSU5LKSB7XHJcbiAgICAgICAgICAgIGxldCBpZCA9IHBhY2thZ2VEYXRhPy5kYXRhPy5bRGF0YUlkcy5TZXJpZXNDYWxjdWxhdGlvbkRhdGFdPy5kYXRhO1xyXG4gICAgICAgICAgICBsZXQgY2FsY3VsYXRpb25EYXRhSW5mb1NldHRpbmcgPSBjb250YWluZXIuZ2V0U2V0dGluZ3NCeUlEKGlkKTtcclxuICAgICAgICAgICAgaWYoIGNhbGN1bGF0aW9uRGF0YUluZm9TZXR0aW5nICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIHNldHRpbmcuc2V0VmFsdWUoU2V0dGluZ0lkcy5TZXJpZXNDYWxjdWxhdGlvbkRhdGEsIGNhbGN1bGF0aW9uRGF0YUluZm9TZXR0aW5nKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRocm93IE1jZUNvbnZlcnNpb25FcnJvci5jcmVhdGVFcnJvckJ5VHlwZShNY2VDb252ZXJzaW9uRXJyb3JUeXBlLk1JU1NJTkdfREFUQSwgYCR7RGF0YUlkcy5TZXJpZXNTaWduYWxEYXRhfS8ke0RhdGFJZHMuU2VyaWVzQ2FsY3VsYXRpb25EYXRhfWApO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHNldHRpbmc7XHJcbiAgICB9XHJcbiAgICBzZXR0aW5nVG9QYWNrYWdlKHNldHRpbmdzRGF0YTogSVNldHRpbmdzKTogUGFja2FnZUFycmF5V2l0aFRvcExldmVsSUQge1xyXG4gICAgICAgIFxyXG4gICAgICAgIGxldCBzZXR0aW5ncyA9IFNldHRpbmdzLmNyZWF0ZShzZXR0aW5nc0RhdGEpO1xyXG5cclxuICAgICAgICBsZXQgc2VyaWVzRGF0YTogeyBbaW5kZXg6IHN0cmluZ106ICBJUGFja2FnZSB9ICA9IHt9O1xyXG5cclxuICAgICAgICBsZXQgcGFja2FnZVN0cnVjdHVyZTogUGFja2FnZUFycmF5V2l0aFRvcExldmVsSUQgPSB7XHJcbiAgICAgICAgICAgICBwYWNrYWdlczogbmV3IEFycmF5PElQYWNrYWdlPigpLFxyXG4gICAgICAgICAgICAgdG9wTGV2ZWxJRDogTmFOXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgaWYoc2V0dGluZ3MudHlwZSA9PT0gdGhpcy5zZXR0aW5nc1R5cGUpIHtcclxuXHJcbiAgICAgICAgICAgIGxldCBpZCA9IE1ldGEuY3JlYXRlSUQoKTtcclxuICAgICAgICAgICAgbGV0IGFkZGl0aW9uYWxNZXRhSW5mbyA9IFt7a2V5OiBBZGRpdGlvbmFsTWV0YUtleXMuT0JKRUNUVFlQRSwgdmFsdWU6IHRoaXMub2JqZWN0VHlwZX0sIHtrZXk6IEFkZGl0aW9uYWxNZXRhS2V5cy5JRCwgdmFsdWU6IGlkfSwge2tleTogQWRkaXRpb25hbE1ldGFLZXlzLlZFUlNJT04sIHZhbHVlOiB0aGlzLmN1cnJlbnRQYWNrYWdlVmVyc2lvbn1dO1xyXG4gICAgICAgICAgICBsZXQgc2VyaWVzTWV0YSA9IG5ldyBNZXRhKERhdGFUeXBlLk9CSkVDVCwgYWRkaXRpb25hbE1ldGFJbmZvKTtcclxuXHJcbiAgICAgICAgICAgIGxldCBzZXJpZXNJZERhdGEgPSBzZXR0aW5ncy5nZXRWYWx1ZShTZXR0aW5nSWRzLlNlcmllc0lkKTtcclxuICAgICAgICAgICAgaWYoc2VyaWVzSWREYXRhICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIHNlcmllc0RhdGFbRGF0YUlkcy5TZXJpZXNJZF0gPSBuZXcgUGFja2FnZShuZXcgTWV0YShEYXRhVHlwZS5TVFJJTkcpLCBzZXJpZXNJZERhdGEpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgTWNlQ29udmVyc2lvbkVycm9yLmNyZWF0ZUVycm9yQnlUeXBlKE1jZUNvbnZlcnNpb25FcnJvclR5cGUuTUlTU0lOR19EQVRBLCBTZXR0aW5nSWRzLlNlcmllc0lkKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgbGV0IHNlcmllc05hbWVEYXRhID0gc2V0dGluZ3MuZ2V0VmFsdWUoU2V0dGluZ0lkcy5TZXJpZXNOYW1lKTtcclxuICAgICAgICAgICAgaWYoc2VyaWVzTmFtZURhdGEgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgc2VyaWVzRGF0YVtEYXRhSWRzLlNlcmllc05hbWVdID0gbmV3IFBhY2thZ2UobmV3IE1ldGEoRGF0YVR5cGUuU1RSSU5HKSwgc2VyaWVzTmFtZURhdGEpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgTWNlQ29udmVyc2lvbkVycm9yLmNyZWF0ZUVycm9yQnlUeXBlKE1jZUNvbnZlcnNpb25FcnJvclR5cGUuTUlTU0lOR19EQVRBLCBTZXR0aW5nSWRzLlNlcmllc05hbWUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIFxyXG5cclxuICAgICAgICAgICAgbGV0IHNlcmllc0NvbG9yRGF0YSA9IHNldHRpbmdzLmdldFZhbHVlKFNldHRpbmdJZHMuU2VyaWVzQ29sb3IpO1xyXG4gICAgICAgICAgICBpZihzZXJpZXNDb2xvckRhdGEgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgc2VyaWVzRGF0YVtEYXRhSWRzLlNlcmllc0NvbG9yXSA9IG5ldyBQYWNrYWdlKG5ldyBNZXRhKERhdGFUeXBlLlNUUklORyksIHNlcmllc0NvbG9yRGF0YSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBNY2VDb252ZXJzaW9uRXJyb3IuY3JlYXRlRXJyb3JCeVR5cGUoTWNlQ29udmVyc2lvbkVycm9yVHlwZS5NSVNTSU5HX0RBVEEsIFNldHRpbmdJZHMuU2VyaWVzQ29sb3IpO1xyXG5cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgXHJcblxyXG4gICAgICAgICAgICBsZXQgc2VyaWVzU2lnbmFsRGF0YURhdGEgPSBzZXR0aW5ncy5nZXRWYWx1ZShTZXR0aW5nSWRzLlNlcmllc1NpZ25hbERhdGEpO1xyXG4gICAgICAgICAgICBsZXQgc2VyaWVzQ2FsY3VsYXRpb25EYXRhSW5mb0RhdGEgPSBzZXR0aW5ncy5nZXRWYWx1ZShTZXR0aW5nSWRzLlNlcmllc0NhbGN1bGF0aW9uRGF0YSk7XHJcblxyXG4gICAgICAgICAgICBpZihzZXJpZXNTaWduYWxEYXRhRGF0YSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgc2lnbmFsRGF0YVBhY2thZ2VTdHJ1Y3R1cmUgPSBFeHBvcnRDb250YWluZXIuY3JlYXRlUGFja2FnZXMoc2VyaWVzU2lnbmFsRGF0YURhdGEpO1xyXG4gICAgICAgICAgICAgICAgaWYoc2lnbmFsRGF0YVBhY2thZ2VTdHJ1Y3R1cmUucGFja2FnZXMubGVuZ3RoID4gMCAmJiAhTnVtYmVyLmlzTmFOKHNpZ25hbERhdGFQYWNrYWdlU3RydWN0dXJlLnRvcExldmVsSUQpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2VyaWVzRGF0YVtEYXRhSWRzLlNlcmllc1NpZ25hbERhdGFdID0gbmV3IFBhY2thZ2UobmV3IE1ldGEoRGF0YVR5cGUuTElOSyksIHNpZ25hbERhdGFQYWNrYWdlU3RydWN0dXJlLnRvcExldmVsSUQpO1xyXG4gICAgICAgICAgICAgICAgICAgIHBhY2thZ2VTdHJ1Y3R1cmUucGFja2FnZXMucHVzaCguLi5zaWduYWxEYXRhUGFja2FnZVN0cnVjdHVyZS5wYWNrYWdlcyk7XHJcbiAgICAgICAgICAgICAgICB9ZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgTWNlQ29udmVyc2lvbkVycm9yLmNyZWF0ZUVycm9yQnlUeXBlKE1jZUNvbnZlcnNpb25FcnJvclR5cGUuTUlTU0lOR19EQVRBLCBgJHtTZXR0aW5nSWRzLlNlcmllc1NpZ25hbERhdGF9LyR7c2VyaWVzQ2FsY3VsYXRpb25EYXRhSW5mb0RhdGF9YCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZihzZXJpZXNDYWxjdWxhdGlvbkRhdGFJbmZvRGF0YSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgY2FsY3VsYXRpb25EYXRhSW5mb1BhY2thZ2VTdHJ1Y3R1cmUgPSBFeHBvcnRDb250YWluZXIuY3JlYXRlUGFja2FnZXMoc2VyaWVzQ2FsY3VsYXRpb25EYXRhSW5mb0RhdGEpO1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICBpZihjYWxjdWxhdGlvbkRhdGFJbmZvUGFja2FnZVN0cnVjdHVyZS5wYWNrYWdlcy5sZW5ndGggPiAwICYmICFOdW1iZXIuaXNOYU4oY2FsY3VsYXRpb25EYXRhSW5mb1BhY2thZ2VTdHJ1Y3R1cmUudG9wTGV2ZWxJRCkpIHtcclxuICAgICAgICAgICAgICAgICAgICBzZXJpZXNEYXRhW0RhdGFJZHMuU2VyaWVzQ2FsY3VsYXRpb25EYXRhXSA9IG5ldyBQYWNrYWdlKG5ldyBNZXRhKERhdGFUeXBlLkxJTkspLCBjYWxjdWxhdGlvbkRhdGFJbmZvUGFja2FnZVN0cnVjdHVyZS50b3BMZXZlbElEKTtcclxuICAgICAgICAgICAgICAgICAgICBwYWNrYWdlU3RydWN0dXJlLnBhY2thZ2VzLnB1c2goLi4uY2FsY3VsYXRpb25EYXRhSW5mb1BhY2thZ2VTdHJ1Y3R1cmUucGFja2FnZXMpO1xyXG4gICAgICAgICAgICAgICAgfWVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRocm93IE1jZUNvbnZlcnNpb25FcnJvci5jcmVhdGVFcnJvckJ5VHlwZShNY2VDb252ZXJzaW9uRXJyb3JUeXBlLk1JU1NJTkdfREFUQSwgYCR7U2V0dGluZ0lkcy5TZXJpZXNTaWduYWxEYXRhfS8ke3Nlcmllc0NhbGN1bGF0aW9uRGF0YUluZm9EYXRhfWApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgTWNlQ29udmVyc2lvbkVycm9yLmNyZWF0ZUVycm9yQnlUeXBlKE1jZUNvbnZlcnNpb25FcnJvclR5cGUuTUlTU0lOR19EQVRBLCBgJHtTZXR0aW5nSWRzLlNlcmllc1NpZ25hbERhdGF9LyR7c2VyaWVzQ2FsY3VsYXRpb25EYXRhSW5mb0RhdGF9YCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGxldCBzZXJpZXNQYWNrYWdlID0gbmV3IFBhY2thZ2Uoc2VyaWVzTWV0YSwgc2VyaWVzRGF0YSk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBwYWNrYWdlU3RydWN0dXJlLnBhY2thZ2VzLnB1c2goc2VyaWVzUGFja2FnZSk7XHJcbiAgICAgICAgICAgIHBhY2thZ2VTdHJ1Y3R1cmUudG9wTGV2ZWxJRCA9IGlkO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRocm93IE1jZUNvbnZlcnNpb25FcnJvci5jcmVhdGVFcnJvckJ5VHlwZShNY2VDb252ZXJzaW9uRXJyb3JUeXBlLlVOU1VQUE9SVEVEX1ZFUlNJT04sIHRoaXMuc2V0dGluZ3NUeXBlKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBwYWNrYWdlU3RydWN0dXJlO1xyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgeyBCYXNlU2VyaWVzUGFja2FnZUFkYXB0ZXIgfSJdfQ==